@model Semester03.Models.Entities.TblEventBooking
@using System.Globalization

@{
    ViewData["Title"] = "Booking Details";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";

    var vnCulture = new CultureInfo("vi-VN");
}

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Booking #@Model.EventBookingId</h1>

    <div>
        @if (Model.EventBookingPaymentStatus == 1)
        {
            <span class="btn btn-success btn-icon-split">
                <span class="icon text-white-50"><i class="fas fa-check"></i></span>
                <span class="text">Paid / Confirmed</span>
            </span>
        }
        else if (Model.EventBookingPaymentStatus == 2)
        {
            <span class="btn btn-info btn-icon-split">
                <span class="icon text-white-50"><i class="fas fa-gift"></i></span>
                <span class="text">Complimentary (Free)</span>
            </span>
        }
        else if (Model.EventBookingPaymentStatus == 3)
        {
            <span class="btn btn-danger btn-icon-split">
                <span class="icon text-white-50"><i class="fas fa-times"></i></span>
                <span class="text">Cancelled</span>
            </span>
        }
        else
        {
            <span class="btn btn-warning btn-icon-split">
                <span class="icon text-white-50"><i class="fas fa-clock"></i></span>
                <span class="text">Pending Payment</span>
            </span>
        }
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Ticket Information</h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4 font-weight-bold text-gray-700">Event:</div>
                    <div class="col-md-8">
                        <a asp-controller="Events" asp-action="Details" asp-route-id="@Model.EventBookingEventId" class="font-weight-bold">
                            @Model.EventBookingEvent?.EventName
                        </a>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4 font-weight-bold text-gray-700">Date Attending:</div>
                    <div class="col-md-8">
                        <i class="far fa-calendar-alt mr-1"></i>
                        @(Model.EventBookingDate.HasValue? Model.EventBookingDate.Value.ToString("dd/MM/yyyy") : "N/A")
                    </div>
                </div>

                <hr>

                <div class="row mb-2">
                    <div class="col-md-4 font-weight-bold">Quantity:</div>
                    <div class="col-md-8">@Model.EventBookingQuantity tickets</div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-4 font-weight-bold">Unit Price:</div>
                    <div class="col-md-8">
                        @(Model.EventBookingUnitPrice.HasValue? Model.EventBookingUnitPrice.Value.ToString("N0") : "0") VND
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4 font-weight-bold" style="font-size: 1.1rem;">Total Amount:</div>
                    <div class="col-md-8 text-success font-weight-bold" style="font-size: 1.2rem;">
                        @((Model.EventBookingTotalCost ?? 0).ToString("N0")) VND
                    </div>
                </div>

                <div class="bg-light p-3 rounded border">
                    <small class="font-weight-bold text-uppercase text-gray-500">Notes / Special Requests:</small>
                    <p class="mb-0">@(!string.IsNullOrEmpty(Model.EventBookingNotes) ? Model.EventBookingNotes : "None")</p>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-secondary">
                    <i class="fas fa-history mr-1"></i> Transaction History
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm" width="100%">
                        <thead class="thead-light">
                            <tr>
                                <th>Time</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.TblEventBookingHistories != null && Model.TblEventBookingHistories.Any())
                            {
                                foreach (var log in Model.TblEventBookingHistories)
                                {
                                    <tr>
                                        <td style="font-size:0.85rem; white-space:nowrap;">
                                            @log.EventBookingHistoryCreatedAt?.ToString("dd/MM/yy HH:mm")
                                        </td>
                                        <td><span class="badge badge-secondary">@log.EventBookingHistoryAction</span></td>
                                        <td style="font-size:0.85rem;">@log.EventBookingHistoryDetails</td>
                                        <td style="font-size:0.85rem;">
                                            @if (log.EventBookingHistoryUserId == 1)
                                            {
                                                <i>Admin</i>
                                            }
                                            else
                                            {

                                                <span>User #@log.EventBookingHistoryUserId</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No history recorded.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Customer</h6>
            </div>
            <div class="card-body text-center">
                <div class="mb-3">
                    <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem;">
                        @(Model.EventBookingUser?.UsersFullName?.Substring(0, 1).ToUpper() ?? "U")
                    </div>
                </div>
                <h5 class="font-weight-bold">@Model.EventBookingUser?.UsersFullName</h5>
                <p class="text-muted mb-1">@Model.EventBookingUser?.UsersEmail</p>
                <p class="text-muted"><i class="fas fa-phone fa-sm"></i> @Model.EventBookingUser?.UsersPhone</p>
            </div>
        </div>

        <div class="card shadow mb-4 border-bottom-warning">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-warning">Admin Actions</h6>
            </div>
            <div class="card-body">
                <form asp-action="UpdateStatus" asp-route-id="@Model.EventBookingId" method="post">
                    <div class="form-group">
                        <label class="small font-weight-bold">Manual Status Override:</label>
                        <select name="paymentStatus" class="form-control mb-3">
                            <option value="0" selected="@(Model.EventBookingPaymentStatus == 0)">Unpaid</option>
                            <option value="1" selected="@(Model.EventBookingPaymentStatus == 1)">Paid (Confirmed)</option>
                            <option value="2" selected="@(Model.EventBookingPaymentStatus == 2)">Free</option>
                            <option value="3" selected="@(Model.EventBookingPaymentStatus == 3)">Cancelled (Refund)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-warning btn-block">
                        <i class="fas fa-sync-alt"></i> Update Status
                    </button>
                </form>

                <hr />

                <div class="text-center small text-muted">
                    Use this only for corrections or refunds. <br>
                    Normal payments are automated via VNPay.
                </div>

                <hr />

                @{
                    bool canCancel = Model.EventBookingPaymentStatus != 3; // Chưa hủy
                    bool isFuture = Model.EventBookingEvent?.EventStart > DateTime.Now; // Chưa diễn ra
                }

                @if (canCancel && isFuture)
                {
                    <label class="small font-weight-bold text-danger">Emergency Cancellation:</label>
                    <button class="btn btn-danger btn-block" onclick="cancelInDetails()">
                        <i class="fas fa-ban"></i> Cancel Booking & Notify User
                    </button>

                    <form id="detailsCancelForm" asp-action="Cancel" method="post" style="display:none;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.EventBookingId" />
                        <input type="hidden" name="reason" id="detailsCancelReason" />
                    </form>

                    <script>
                        function cancelInDetails() {
                            var r = prompt("Reason for cancellation (sent to user via email):");
                            if (r && r.trim() !== "") {
                                document.getElementById('detailsCancelReason').value = r;
                                document.getElementById('detailsCancelForm').submit();
                            }
                        }
                    </script>
                }
                else if (!canCancel)
                {
                    <div class="alert alert-danger text-center small m-0">Booking is already Cancelled</div>
                }
                else
                {
                    <div class="alert alert-secondary text-center small m-0">
                        <i class="fas fa-lock"></i> Cannot cancel (Event started/ended)
                    </div>
                }
            </div>
        </div>

        <div class="text-center">
            <a asp-action="Index" class="btn btn-secondary btn-icon-split">
                <span class="icon text-white-50"><i class="fas fa-arrow-left"></i></span>
                <span class="text">Back to List</span>
            </a>
        </div>

    </div>
</div>