@model IEnumerable<Semester03.Models.Entities.TblTicket>

@{
    ViewData["Title"] = "Ticket Management";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";

    // Calculate Summary
    var totalSales = Model.Where(t => t.TicketStatus == "sold").Sum(t => t.TicketPrice);
    var countSold = Model.Count(t => t.TicketStatus == "sold");
}

<h1 class="h3 mb-2 text-gray-800">Ticket Management</h1>
<p class="mb-4">Search, filter, and manage ticket sales.</p>

<div class="card mb-4 border-bottom-primary">
    <div class="card-body">
        <form method="get" asp-action="Index" class="form-row align-items-end">
            <div class="col-md-3 mb-2">
                <label class="small font-weight-bold">Keyword</label>
                <input type="text" name="search" value="@ViewData["CurrentSearch"]" class="form-control" placeholder="ID, Name, Phone, Movie..." />
            </div>

            <div class="col-md-2 mb-2">
                <label class="small font-weight-bold">From Date</label>
                <input type="date" name="fromDate" value="@ViewData["FromDate"]" class="form-control" />
            </div>
            <div class="col-md-2 mb-2">
                <label class="small font-weight-bold">To Date</label>
                <input type="date" name="toDate" value="@ViewData["ToDate"]" class="form-control" />
            </div>

            <div class="col-md-2 mb-2">
                <label class="small font-weight-bold">Status</label>
                <select name="status" class="form-control">
                    <option value="all">All Status</option>
                    <option value="sold" selected="@((string)ViewData["CurrentStatus"] == "sold")">Sold</option>
                    <option value="cancelled" selected="@((string)ViewData["CurrentStatus"] == "cancelled")">Cancelled</option>
                </select>
            </div>

            <div class="col-md-3 mb-2 d-flex">
                <button type="submit" class="btn btn-primary mr-2 flex-fill">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <a asp-action="Index" class="btn btn-secondary mr-2" title="Reset">
                    <i class="fas fa-undo"></i>
                </a>

                <button type="submit" formaction="@Url.Action("ExportSummary")" formmethod="post" class="btn btn-success" title="Export Excel">
                    <i class="fas fa-file-excel"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Revenue (Current View)</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@totalSales.ToString("N0") VND</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-dollar-sign fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tickets Sold</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@countSold</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-ticket-alt fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Ticket List</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                <thead class="thead-light">
                    <tr>
                        <th>ID</th>
                        <th>Movie / Showtime</th>
                        <th>Seat</th>
                        <th>Customer</th>
                        <th>Price(VND)</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        bool isSold = item.TicketStatus.ToLower() == "sold";

                        <tr class="@(isSold ? "" : "table-secondary text-muted")">
                            <td class="font-weight-bold">#@item.TicketId</td>
                            <td>
                                <div class="font-weight-bold text-primary">@item.TicketShowtimeSeat?.ShowtimeSeatShowtime?.ShowtimeMovie?.MovieTitle</div>
                                <small>
                                    @item.TicketShowtimeSeat?.ShowtimeSeatShowtime?.ShowtimeStart.ToString("dd/MM HH:mm")
                                    (@item.TicketShowtimeSeat?.ShowtimeSeatShowtime?.ShowtimeScreen?.ScreenName)
                                </small>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-info" style="font-size: 0.9rem;">
                                    @item.TicketShowtimeSeat?.ShowtimeSeatSeat?.SeatLabel
                                </span>
                            </td>
                            <td>
                                <div>@item.TicketBuyerUser?.UsersFullName</div>
                                <small>@item.TicketBuyerUser?.UsersPhone</small>
                            </td>
                            <td>@item.TicketPrice.ToString("N0")</td>
                            <td>
                                @if (isSold)
                                {
                                    <span class="badge badge-success">Sold</span>
                                }
                                else
                                {

                                    <span class="badge badge-secondary">Cancelled</span>
                                }
                            </td>
                            <td>
                                @item.TicketCreatedAt?.ToString("dd/MM/yy HH:mm")
                            </td>
                            <td>
                                <a asp-action="Details" asp-route-id="@item.TicketId" class="btn btn-info btn-sm">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        $(document).ready(function() {
            $('#dataTable').DataTable({
                "order": [[ 0, "desc" ]] 
            });
        });
    </script>
}