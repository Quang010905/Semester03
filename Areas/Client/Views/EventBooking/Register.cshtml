@model Semester03.Areas.Client.Models.ViewModels.EventRegisterVm
@{
    Layout = "~/Areas/Client/Views/Shared/_LayoutClient.cshtml";
    ViewData["Title"] = "Register for Event";
    var price = ViewBag.Price as decimal? ?? 0m;
}

@section Styles {
    <style>
        .event-register-page {
            max-width: 1200px;
            margin: auto;
        }

        .event-info-card {
            background: #fff;
            padding: 1.25rem;
            border-radius: 1rem;
            box-shadow: 0 10px 26px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }

        .register-card {
            background: #fff;
            border-radius: 1rem;
            padding: 1.25rem;
            box-shadow: 0 10px 26px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }

        #registerAlert {
            border-radius: .6rem;
            padding: .75rem 1rem;
            font-size: .9rem;
        }
    </style>
}

<div class="container py-4 event-register-page">

    <div class="row g-4">

        <!-- EVENT INFO -->
        <div class="col-md-8">
            <div class="event-info-card">
                <h3 class="mb-2">@Model.Event.Title</h3>
                <p class="text-muted">@Model.Event.Description</p>

                <p>
                    <strong>Date:</strong>
                    @Model.Event.StartDate.ToString("dd/MM/yyyy")
                    @if (Model.Event.EndDate.HasValue)
                    {
                        <span> – @Model.Event.EndDate.Value.ToString("dd/MM/yyyy")</span>
                    }
                </p>

                <p><strong>Max slots:</strong> @Model.Event.MaxSlot</p>
                <p><strong>Available:</strong> @Model.AvailableSlots</p>
            </div>
        </div>

        <!-- REGISTER FORM -->
        <div class="col-md-4">
            <div class="register-card">
                <h5 class="mb-3">Register</h5>

                <form id="registerForm"
                      asp-area="Client" asp-controller="EventBooking" asp-action="CreateBooking"
                      method="post" novalidate>
                    @Html.AntiForgeryToken()

                    <input type="hidden" name="eventId" value="@Model.Event.Id" />

                    <div class="mb-2">
                        <label class="form-label">Full name</label>
                        <input id="contactName" name="contactName" class="form-control" required />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Email</label>
                        <input id="contactEmail" name="contactEmail" type="email" class="form-control" required />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Quantity</label>
                        <input id="quantity" name="quantity" type="number"
                               min="1" max="@Model.AvailableSlots" value="1"
                               class="form-control" required />
                    </div>

                    @if (price > 0m)
                    {
                        <div class="mb-2">
                            <label class="form-label">Price per ticket</label>
                            <div id="pricePerTicket">@price.ToString("N0") VND</div>
                        </div>

                        <button id="btnSubmit" class="btn btn-primary w-100" type="submit">
                            Book & Pay
                        </button>
                    }
                    else
                    {
                        <button id="btnSubmit" class="btn btn-success w-100" type="submit">
                            Register (Free)
                        </button>
                    }
                </form>

                <div id="registerAlert" class="mt-3" style="display:none;"></div>
            </div>
        </div>

    </div>
</div>


@section Scripts {
    <script>
        (function () {
            const form = document.getElementById('registerForm');
            const btn = document.getElementById('btnSubmit');
            const alertBox = document.getElementById('registerAlert');

            function showAlert(msg, isError = true) {
                alertBox.textContent = msg;
                alertBox.className = `alert ${isError ? 'alert-danger' : 'alert-success'}`;
                alertBox.style.display = 'block';
            }

            function clearAlert() {
                alertBox.style.display = 'none';
                alertBox.textContent = '';
                alertBox.className = '';
            }

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                clearAlert();

                // validation
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const originalText = btn.innerText;
                btn.disabled = true;
                btn.innerText = "Processing...";

                try {
                    const formData = new FormData(form);
                    const resp = await fetch('@Url.Action("CreateBooking", "EventBooking", new { area = "Client" })', {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "Accept": "application/json"
                        },
                        body: formData,
                        credentials: "same-origin"
                    });

                    if (resp.redirected) {
                        window.location.href = resp.url;
                        return;
                    }

                    const text = await resp.text();
                    let data;

                    try {
                        data = JSON.parse(text);
                    } catch {
                        throw new Error("Server returned invalid JSON.");
                    }

                    if (!data.success) {
                        throw new Error(data.message || "Booking failed.");
                    }

                    if (data.url || data.redirectUrl) {
                        window.location.href = data.url || data.redirectUrl;
                        return;
                    }

                    showAlert("Booking successful!", false);
                }
                catch (err) {
                    showAlert("Error: " + err.message, true);
                }
                finally {
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            });
        })();
    </script>
}
