@model Semester03.Areas.Client.Models.ViewModels.MapViewModel

@{
    ViewData["Title"] = "Mall Floor Plan — Tube / Diamond (Client)";
    Layout = "_LayoutClient";
    int defaultCapacityPerFloor = 40;
    var floors = Model?.AvailableFloors ?? new List<int> { Model?.FloorNumber ?? 0 };
    var selectedFloor = Model?.FloorNumber ?? floors.FirstOrDefault();
    var positions = Model?.Positions ?? new List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto>();
}

<style>
    /* ========== Layout (tube) ========== */
    * {
        box-sizing: border-box;
    }

    .card-tube {
        background: #fff;
        border: 1px solid #e6e8ee;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 18px;
        box-shadow: 0 6px 18px rgba(14,20,30,0.04);
    }

    .tube-wrap {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 8px 4px;
    }

    .tube {
        display: inline-block;
        min-width: 1200px;
        padding: 14px;
        border-radius: 10px;
        background: linear-gradient(180deg,#f6f8fb,#eef2f8);
        border: 1px solid #dfe4ee;
    }

    .tube-inner {
        display: flex;
        flex-direction: column;
        gap: 14px;
        min-width: 1000px;
    }

    .tube-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .end-cap {
        width: 44px;
        height: 92px;
        background: #e74a3b;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        writing-mode: vertical-lr;
        font-weight: 900;
        border-radius: 6px;
        flex: 0 0 44px;
    }

    .shop-cluster {
        display: grid;
        grid-template-columns: repeat(5,1fr);
        gap: 10px;
        min-width: 540px;
    }

    .shop-unit {
        background: #fff;
        border-radius: 8px;
        min-height: 86px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 8px;
        border: 1px solid #eef2f6;
        transition: transform .12s ease, box-shadow .12s ease;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
    }

        .shop-unit:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 18px rgba(16,24,40,0.08);
            border-color: #4e73df;
            z-index: 15;
        }

    .shop-thumb {
        width: 56px;
        height: 42px;
        border-radius: 6px;
        background: #f5f7fa;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-bottom: 6px;
    }

    .shop-title {
        font-weight: 800;
        font-size: 0.68rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .shop-sub {
        font-size: 0.62rem;
        opacity: 0.9;
    }

    /* variants */
    .unit-occupied {
        background: linear-gradient(180deg,#cfe9ff,#c6e2ff);
        color: #083358;
    }

    .unit-vacant {
        background: linear-gradient(180deg,#e6f4ea,#dff0e6);
        color: #155724;
    }

    .unit-void {
        background: transparent;
        border: 2px dashed rgba(0,0,0,0.05);
    }

    /* click effect (temporary) */
    .shop-unit.active-click {
        animation: pop .42s ease;
        box-shadow: 0 14px 36px rgba(16,24,40,0.18);
        transform: translateY(-8px) scale(1.02);
    }
    @@keyframes pop {
        0%

    {
        transform: translateY(0) scale(1);
    }

    50% {
        transform: translateY(-8px) scale(1.03);
    }

    100% {
        transform: translateY(-6px) scale(1.02);
    }

    }

    /* modal / slide panel (custom, no bootstrap required) */
    .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1200;
        padding: 20px;
    }

    .panel {
        width: 680px;
        max-width: 96%;
        background: #fff;
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 14px 40px rgba(7,10,25,0.45);
        transform: translateY(20px);
        opacity: 0;
        transition: all .18s ease;
        max-height: 88vh;
        overflow: auto;
    }

    .overlay.visible {
        display: flex;
    }

    .panel.visible {
        transform: translateY(0);
        opacity: 1;
    }

    /* panel header */
    .panel .hdr {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
    }

        .panel .hdr h4 {
            margin: 0;
            font-size: 1.05rem;
        }

    .panel .close-btn {
        border: 0;
        background: transparent;
        font-size: 1.2rem;
        cursor: pointer;
    }

    /* tenant content */
    .tenant-row {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .tenant-img {
        width: 140px;
        height: 100px;
        border-radius: 8px;
        background: #f5f7fa;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .tenant-body {
        flex: 1;
    }

        .tenant-body p {
            margin: 6px 0;
            color: #374151;
            font-size: 0.95rem;
        }

    .meta {
        font-size: 0.85rem;
        color: #6b7280;
    }

    /* fallback no-shop */
    .no-shop {
        text-align: center;
        padding: 24px 12px;
        color: #6b7280;
        font-weight: 700;
    }

    /* floor tabs */
    .floors-toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
    }

    .floor-tab {
        border-radius: 20px;
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        cursor: pointer;
        font-weight: 700;
        color: #374151;
        user-select: none;
    }

        .floor-tab.active {
            background: #2b6fb2;
            color: #fff;
            border-color: #2b6fb2;
        }

    /* responsive */
    @@media (max-width:640px) {
        .tenant-row

    {
        flex-direction: column;
    }

    .tenant-img {
        width: 100%;
        height: 140px;
    }

    .panel {
        padding: 12px;
    }

    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="h3 mb-0">Mall Floor Plan — Tube / Diamond</h1>
        <small class="text-muted">Hiển thị vị trí tenant theo từng tầng (MapViewModel)</small>
    </div>

    <!-- RIGHT SIDE: removed combobox as requested -->
    <div>
        <!-- left intentionally empty: floor selection handled by tabs above -->
    </div>
</div>

@if (!floors.Any())
{
    <div class="alert alert-warning">Không có tầng để hiển thị.</div>
}

@functions {
    private List<List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto>> ChunkInto(List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto> src)
    {
        var res = new List<List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto>>();
        if (src == null) return res;
        for (int i = 0; i < src.Count; i += 5) res.Add(src.Skip(i).Take(5).ToList());
        return res;
    }
}

<div class="d-flex gap-2 mb-3 floors-toolbar">
    @foreach (var f in floors.OrderBy(x => x))
    {
        var css = (f == selectedFloor) ? "floor-tab active" : "floor-tab";
        <div class="@css" data-floor="@f"> @(f == 0 ? "G (0)" : "Tầng " + f) </div>
    }
</div>

@foreach (var floor in floors.OrderBy(x => x))
{
    var floorPositions = positions.Where(p => p.TenantPosition_Floor == floor).ToList();
    bool isGround = (floor == 0 || floor == 1);

    var topRow = floorPositions.Where(p => (p.TenantPosition_TopPct ?? 0m) < 50m).OrderBy(p => (p.TenantPosition_LeftPct ?? 0m)).ToList();
    var bottomRow = floorPositions.Where(p => (p.TenantPosition_TopPct ?? 0m) >= 50m).OrderBy(p => (p.TenantPosition_LeftPct ?? 0m)).ToList();

    var topChunks = ChunkInto(topRow);
    var botChunks = ChunkInto(bottomRow);

    var hiddenStyle = (floor == selectedFloor) ? "" : "display:none;";
    <div class="card-tube" data-floor="@floor" style="@hiddenStyle">
        <div class="d-flex justify-content-between align-items-end mb-2">
            <div>
                <h5 class="m-0 fw-bold">Floor @floor @(isGround ? "(Ground Level)" : "")</h5>
                <small class="text-muted">Diện tích tầng: @Model.FloorAreaM2 m² · Dành riêng: @Model.ReservedAreaM2 m² · Diện tích ô: @Model.PositionAreaM2 m²</small>
            </div>
            <div><small class="text-muted">Occupancy: @floorPositions.Count(x => x.TenantPosition_Status == 1) / @defaultCapacityPerFloor Units</small></div>
        </div>

        <div class="tube-wrap" aria-label="Floor @floor tube">
            <div class="tube" role="region" aria-label="Tube map for floor @floor">
                <div class="tube-inner">

                    <!-- TOP ROW -->
                    <div class="tube-row">
                        <div class="end-cap">EXIT</div>

                        @foreach (var cluster in topChunks)
                        {
                            <div class="shop-cluster">
                                @foreach (var pos in cluster)
                                {
                                    var occupied = pos.TenantPosition_Status == 1;
                                    var dataTenantId = pos.Tenant?.Tenant_Id ?? 0;
                                    var dataTenantName = (pos.Tenant?.Tenant_Name ?? "");
                                    var dataTenantImg = (pos.Tenant?.Tenant_Img ?? "");
                                    var dataTenantDesc = (pos.Tenant?.Tenant_Description ?? "");
                                    var dataLocation = pos.TenantPosition_Location ?? "";
                                    var dataArea = pos.TenantPosition_Area_M2.ToString();
                                    var dataRent = pos.TenantPosition_Rent_Price_Per_M2?.ToString() ?? "";
                                    <a href="#" class="shop-unit @(occupied ? "unit-occupied" : "unit-vacant")"
                                       data-id="@pos.TenantPosition_ID"
                                       data-floor="@pos.TenantPosition_Floor"
                                       data-location="@dataLocation"
                                       data-area="@dataArea"
                                       data-rent="@dataRent"
                                       data-status="@(pos.TenantPosition_Status)"
                                       data-tenant-id="@dataTenantId"
                                       data-tenant-name="@Html.Raw(System.Net.WebUtility.HtmlEncode(dataTenantName))"
                                       data-tenant-img="@Html.Raw(System.Net.WebUtility.HtmlEncode(dataTenantImg))"
                                       data-tenant-desc="@Html.Raw(System.Net.WebUtility.HtmlEncode(dataTenantDesc))"
                                       title="@dataLocation">
                                        <div class="shop-thumb">
                                            @if (!string.IsNullOrWhiteSpace(pos.Tenant?.Tenant_Img))
                                            {
                                                var src = pos.Tenant.Tenant_Img.StartsWith("wwwroot/") ? "/" + pos.Tenant.Tenant_Img.Substring("wwwroot/".Length) : pos.Tenant.Tenant_Img;
                                                <img src="@src" alt="@pos.Tenant?.Tenant_Name" style="max-width:100%;max-height:100%;" />
                                            }
                                            else
                                            {
                                                <span style="font-size:0.82rem;">@pos.TenantPosition_ID</span>
                                            }
                                        </div>
                                        <div class="shop-title">@pos.TenantPosition_Location</div>
                                        <div class="shop-sub">@((occupied && pos.Tenant != null) ? pos.Tenant.Tenant_Name : "VACANT")</div>
                                    </a>
                                }
                                @for (int i = 0; i < (5 - cluster.Count); i++)
                                {
                                    <div class="shop-unit unit-void" aria-hidden="true"></div>
                                }
                            </div>
                        }

                        <div class="util-block util-wc" title="WC" style="background:#36b9cc;color:#fff;padding:8px;border-radius:8px;min-width:92px;">
                            <i class="fas fa-restroom" style="font-size:18px;margin-bottom:6px;"></i>
                            <div style="font-size:0.7rem;">WC</div>
                        </div>

                        @if (isGround)
                        {
                            <div class="gate-center" title="Gate / North">NORTH</div>
                        }
                        else
                        {
                            <div class="util-block util-info" title="Digital Map" style="background:#4e73df;color:#fff;min-width:92px;padding:8px;border-radius:8px;">
                                <i class="fas fa-map-marked-alt" style="font-size:16px;"></i>
                                <div style="font-size:0.7rem;">MAP</div>
                            </div>
                        }

                        <div class="end-cap" style="transform:rotate(180deg);">EXIT</div>
                    </div>

                    <!-- CORRIDOR -->
                    <div class="corridor" style="height:68px;border-radius:8px;padding:8px 20px; display:flex;align-items:center;justify-content:space-between;border:1px dashed #e0e6ef;">
                        <div style="display:flex;align-items:center;gap:14px;">
                            <div style="color:#b54444;font-weight:900;">WEST</div>
                            <div style="padding:6px 12px;border-radius:26px;background:#eef3fb;border:1px solid #d6def6;font-weight:700;"> <i class="fas fa-level-up-alt"></i> <span style="margin-left:6px;">ESCALATOR • STAIRS</span></div>
                        </div>

                        <div style="font-weight:800;color:#6f7b89;">MAIN CORRIDOR (210m)</div>

                        <div style="display:flex;align-items:center;gap:14px;">
                            <div style="padding:6px 12px;border-radius:26px;background:#eef3fb;border:1px solid #d6def6;font-weight:700;"> <i class="fas fa-level-up-alt"></i> <span style="margin-left:6px;">ESCALATOR • STAIRS</span></div>
                            <div style="color:#b54444;font-weight:900;">EAST</div>
                        </div>
                    </div>

                    <!-- BOTTOM ROW -->
                    <div class="tube-row">
                        <div class="end-cap">EXIT</div>

                        @foreach (var cluster in botChunks)
                        {
                            <div class="shop-cluster">
                                @foreach (var pos in cluster)
                                {
                                    var occupied = pos.TenantPosition_Status == 1;
                                    var dataTenantId = pos.Tenant?.Tenant_Id ?? 0;
                                    var dataTenantName = (pos.Tenant?.Tenant_Name ?? "");
                                    var dataTenantImg = (pos.Tenant?.Tenant_Img ?? "");
                                    var dataTenantDesc = (pos.Tenant?.Tenant_Description ?? "");
                                    var dataLocation = pos.TenantPosition_Location ?? "";
                                    var dataArea = pos.TenantPosition_Area_M2.ToString();
                                    var dataRent = pos.TenantPosition_Rent_Price_Per_M2?.ToString() ?? "";
                                    <a href="#" class="shop-unit @(occupied ? "unit-occupied" : "unit-vacant")"
                                       data-id="@pos.TenantPosition_ID"
                                       data-floor="@pos.TenantPosition_Floor"
                                       data-location="@dataLocation"
                                       data-area="@dataArea"
                                       data-rent="@dataRent"
                                       data-status="@(pos.TenantPosition_Status)"
                                       data-tenant-id="@dataTenantId"
                                       data-tenant-name="@Html.Raw(System.Net.WebUtility.HtmlEncode(dataTenantName))"
                                       data-tenant-img="@Html.Raw(System.Net.WebUtility.HtmlEncode(dataTenantImg))"
                                       data-tenant-desc="@Html.Raw(System.Net.WebUtility.HtmlEncode(dataTenantDesc))"
                                       title="@dataLocation">
                                        <div class="shop-thumb">
                                            @{
                                                if (!string.IsNullOrWhiteSpace(pos.Tenant?.Tenant_Img))
                                                {
                                                    var src = pos.Tenant.Tenant_Img.StartsWith("wwwroot/") ? "/" + pos.Tenant.Tenant_Img.Substring("wwwroot/".Length) : pos.Tenant.Tenant_Img;
                                                    <img src="@src" alt="@pos.Tenant?.Tenant_Name" style="max-width:100%;max-height:100%;" />
                                                }
                                                else
                                                {
                                                    <span style="font-size:0.82rem;">@pos.TenantPosition_ID</span>
                                                }
                                            }
                                        </div>
                                        <div class="shop-title">@pos.TenantPosition_Location</div>
                                        <div class="shop-sub">@((occupied && pos.Tenant != null) ? pos.Tenant.Tenant_Name : "VACANT")</div>
                                    </a>
                                }
                                @for (int i = 0; i < (5 - cluster.Count); i++)
                                {
                                    <div class="shop-unit unit-void" aria-hidden="true"></div>
                                }
                            </div>
                        }

                        <div class="util-block util-lift" title="Lift" style="background:#f6c23e;color:#222;padding:8px;border-radius:8px;min-width:92px;">
                            <i class="fas fa-elevator" style="font-size:18px;margin-bottom:6px;"></i>
                            <div style="font-size:0.7rem;color:inherit;">LIFT</div>
                        </div>

                        <div class="end-cap" style="transform:rotate(180deg);">EXIT</div>
                    </div>

                </div> <!-- tube-inner -->
            </div> <!-- tube -->
        </div> <!-- tube-wrap -->
    </div> <!-- card-tube -->
}

<!-- Modal / Panel HTML (hidden until needed) -->
<div id="tenantOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="tenantPanel" class="panel" role="document" aria-hidden="true">
        <div class="hdr">
            <h4 id="panelTitle">Shop details</h4>
            <button id="panelClose" class="close-btn" aria-label="Close">✕</button>
        </div>

        <div id="panelContent">
            <!-- filled dynamically -->
            <div id="noShop" class="no-shop" style="display:none;">
                Không có shop (No shop assigned to this position).
            </div>

            <div id="tenantInfo" style="display:none;">
                <div class="tenant-row">
                    <div class="tenant-img" id="tenantImg">
                        <!-- image -->
                    </div>
                    <div class="tenant-body">
                        <p id="tenantName" style="font-size:1.05rem;font-weight:800;margin:0 0 6px 0;"></p>
                        <p class="meta" id="positionMeta"></p>
                        <p id="tenantDesc" style="margin-top:8px;color:#374151;"></p>
                    </div>
                </div>

                <hr />

                <div style="display:flex;gap:12px;flex-wrap:wrap;">
                    <div class="meta">Location: <strong id="metaLocation"></strong></div>
                    <div class="meta">Floor: <strong id="metaFloor"></strong></div>
                    <div class="meta">Area (m²): <strong id="metaArea"></strong></div>
                    <div class="meta">Rent/m²: <strong id="metaRent"></strong></div>
                    <div class="meta">Status: <strong id="metaStatus"></strong></div>
                </div>
            </div>
        </div>

        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <a id="detailsLink" class="btn btn-sm btn-primary" href="#" style="text-decoration:none;color:white;display:none;">Xem chi tiết</a>
            <button id="panelClose2" class="btn btn-sm btn-secondary" style="margin-left:8px;">Đóng</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            // tabs: show/hide floors client-side
            document.querySelectorAll('.floor-tab').forEach(function(t){
                t.addEventListener('click', function(e){
                    e.preventDefault();
                    var f = this.getAttribute('data-floor');
                    document.querySelectorAll('.floor-tab').forEach(x=>x.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.card-tube').forEach(function(w){
                        w.style.display = (w.getAttribute('data-floor') === f) ? '' : 'none';
                    });
                    // scroll left to start for visible
                    setTimeout(function(){
                        var vis = document.querySelector('.card-tube[style*="display:"] .tube-wrap');
                        if(vis) vis.scrollLeft = 0;
                    }, 80);
                });
            });

            // modal / panel elements
            var overlay = document.getElementById('tenantOverlay');
            var panel = document.getElementById('tenantPanel');
            var panelTitle = document.getElementById('panelTitle');
            var panelClose = document.getElementById('panelClose');
            var panelClose2 = document.getElementById('panelClose2');

            function openPanel(){
                overlay.classList.add('visible');
                panel.classList.add('visible');
                overlay.setAttribute('aria-hidden','false');
                panel.setAttribute('aria-hidden','false');
            }
            function closePanel(){
                panel.classList.remove('visible');
                overlay.classList.remove('visible');
                overlay.setAttribute('aria-hidden','true');
                panel.setAttribute('aria-hidden','true');
            }
            panelClose.addEventListener('click', closePanel);
            panelClose2.addEventListener('click', closePanel);
            overlay.addEventListener('click', function(e){
                if(e.target === overlay) closePanel();
            });
            window.addEventListener('keydown', function(e){ if(e.key === 'Escape') closePanel(); });

            // helper: set panel content
            function populatePanelFromElem(elem){
                var tenantId = elem.getAttribute('data-tenant-id') || "";
                var tenantName = elem.getAttribute('data-tenant-name') || "";
                var tenantImg = elem.getAttribute('data-tenant-img') || "";
                var tenantDesc = elem.getAttribute('data-tenant-desc') || "";
                var location = elem.getAttribute('data-location') || "";
                var floor = elem.getAttribute('data-floor') || "";
                var area = elem.getAttribute('data-area') || "";
                var rent = elem.getAttribute('data-rent') || "";
                var status = elem.getAttribute('data-status') || "0";

                var tenantInfo = document.getElementById('tenantInfo');
                var noShop = document.getElementById('noShop');

                if (!tenantId || tenantId === "0" || tenantName.trim() === ""){
                    // no tenant assigned
                    noShop.style.display = '';
                    tenantInfo.style.display = 'none';
                    document.getElementById('detailsLink').style.display = 'none';
                    panelTitle.textContent = 'No shop assigned';
                } else {
                    noShop.style.display = 'none';
                    tenantInfo.style.display = '';
                    // image
                    var imgWrap = document.getElementById('tenantImg');
                    imgWrap.innerHTML = '';
                    if (tenantImg && tenantImg.length > 5){
                        var src = tenantImg;
                        if (tenantImg.indexOf('wwwroot/') === 0) src = '/' + tenantImg.substring('wwwroot/'.length);
                        var img = document.createElement('img');
                        img.src = src;
                        img.alt = tenantName;
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '100%';
                        imgWrap.appendChild(img);
                    } else {
                        imgWrap.textContent = tenantId;
                    }

                    document.getElementById('tenantName').textContent = tenantName;
                    document.getElementById('metaLocation').textContent = location;
                    document.getElementById('metaFloor').textContent = floor;
                    document.getElementById('metaArea').textContent = area;
                    document.getElementById('metaRent').textContent = rent;
                    document.getElementById('metaStatus').textContent = (status === "1") ? "Occupied" : "Vacant";
                    panelTitle.textContent = tenantName + " — Shop info";

                    // details link
                    var detailsLink = document.getElementById('detailsLink');
                    detailsLink.style.display = '';
                    detailsLink.href = '@Url.Action("Details", "Stores", new { area = "Client" })' + '/' + elem.getAttribute('data-id');
                }
            }

            // attach click handlers to shop units (delegation)
            document.addEventListener('click', function(e){
                var target = e.target.closest('.shop-unit');
                if (!target) return;
                e.preventDefault();

                // add click animation
                target.classList.remove('active-click');
                // force reflow to restart animation
                void target.offsetWidth;
                target.classList.add('active-click');
                setTimeout(function(){ target.classList.remove('active-click'); }, 700);

                // populate and open panel
                populatePanelFromElem(target);
                openPanel();
            });

        })();
    </script>
}
