@model Semester03.Areas.Client.Models.ViewModels.MapViewModel
@{
    ViewData["Title"] = "Mall Floor Plan";
    Layout = "_LayoutClient";
    int defaultCapacityPerFloor = 40;
    var floors = Model?.AvailableFloors ?? new List<int> { Model?.FloorNumber ?? 0 };
    var selectedFloor = Model?.FloorNumber ?? floors.FirstOrDefault();
    var positions = Model?.Positions ?? new List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto>();
}

<style>
    /* reset box-sizing to avoid width surprises */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    .floor-wrapper {
        background: #fff;
        border: 1px solid #e1e3ea;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 24px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.06);
    }

    .floors-toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
    }

    .floor-tab {
        border-radius: 20px;
        padding: 6px 10px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        cursor: pointer;
        font-weight: 700;
        color: #374151;
        user-select: none;
    }

        .floor-tab.active {
            background: #2b6fb2;
            color: #fff;
            border-color: #2b6fb2;
        }

    /* viewport that clips content - prevents overflow of the map outside the frame */
    .map-viewport {
        width: 100%;
        height: 420px;
        overflow: hidden; /* clip any overflow */
        position: relative;
        border-radius: 6px;
        background: transparent;
        padding: 10px; /* breathing room so transform edge isn't clipped harshly */
        display: block;
    }

    /* actual content - we keep an internal "design width" and scale it down to fit */
    .map-content {
        transform-origin: 0 0; /* important: we compute translate/scale in JS */
        transition: transform .06s linear;
        display: block;
        /* design size: this is the internal width & height of the layout */
        width: 1240px; /* change if you prefer wider/narrower internal canvas */
        background: transparent;
        margin: 0 auto;
    }

    /* layout inside the design canvas */
    .floor-layout {
        width: 100%;
        background: #eaecf4;
        border: 2px solid #5a5c69;
        padding: 8px;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .shop-strip {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .shop-cluster {
        display: flex;
        gap: 8px;
        flex: 5;
        align-items: stretch;
    }

    .end-cap {
        width: 44px;
        background: #e74a3b;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        writing-mode: vertical-lr;
        font-weight: 900;
        border-radius: 6px;
        min-height: 72px;
    }

    /* shop unit - vertical rectangle */
    .shop-unit {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        gap: 6px;
        text-align: center;
        border-radius: 6px;
        padding: 8px 6px;
        text-decoration: none;
        color: inherit;
        transition: transform .12s ease, box-shadow .12s ease;
        min-width: 84px; /* control width of each cell */
        max-width: 84px;
        height: 110px; /* vertical rectangle */
        background: #fff;
        border: 1px solid #e9ecef;
        box-sizing: border-box;
    }

        .shop-unit:hover {
            transform: translateY(-6px);
            z-index: 20;
            box-shadow: 0 10px 24px rgba(16,24,40,0.08);
            border-color: #4e73df;
        }

    .unit-void {
        background: transparent;
        border: 1px dashed rgba(0,0,0,0.06);
        min-width: 84px;
        height: 110px;
    }

    .unit-vacant {
        background: #e6f4ea;
        color: #155724;
    }

    .unit-occupied {
        background: #cce5ff;
        color: #003366;
    }

    .shop-thumb {
        width: 56px;
        height: 48px;
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f3f5f7;
    }

        .shop-thumb img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

    .shop-location {
        font-size: 0.66rem;
        color: #374151;
        font-weight: 700;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .shop-status {
        font-size: 0.72rem;
        font-weight: 800;
        margin-top: 4px;
        color: inherit;
    }

    .map-controls {
        position: absolute;
        right: 16px;
        top: 16px;
        z-index: 60;
        display: flex;
        gap: 6px;
    }

        .map-controls button {
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: #fff;
            padding: 6px 8px;
            cursor: pointer;
        }

    /* responsive: reduce cell sizes slightly on small screens */
    @@media (max-width:1100px) {
        .map-content

    {
        width: 1000px;
    }
    /* internal design smaller for small screens */
    .shop-unit, .unit-void {
        min-width: 68px;
        max-width: 68px;
        height: 96px;
    }

    .shop-thumb {
        width: 48px;
        height: 36px;
    }

    }
</style>

<h1 class="h3 mb-2 text-gray-800">Mall Floor Plan</h1>
<p class="mb-3 text-muted">Hiển thị vị trí tenant theo từng tầng — dữ liệu lấy từ Tbl_TenantPosition.</p>

<div class="floors-toolbar mb-3">
    @foreach (var f in floors.OrderBy(x => x))
    {
        var css = (f == selectedFloor) ? "floor-tab active" : "floor-tab";
        <div class="@css" data-floor="@f"> @(f == 0 ? "G (0)" : "Tầng " + f) </div>
    }
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <span class="text-muted small">Zoom / Pan</span>
        <button class="btn btn-sm btn-outline-secondary" id="globalZoomOut" title="Zoom out">-</button>
        <button class="btn btn-sm btn-outline-secondary" id="globalZoomReset" title="Reset">⟳</button>
        <button class="btn btn-sm btn-outline-secondary" id="globalZoomIn" title="Zoom in">+</button>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div><strong>Positions:</strong> @(ViewData["PositionsCount"] ?? positions.Count)</div>
    <div class="d-flex align-items-center gap-2">
        <form id="floorSelectForm" method="get" action="@Url.Action("Index","Map", new { area = "Client" })" class="m-0 p-0 d-flex align-items-center gap-2">
            <label class="small text-muted mb-0 me-1">Chọn tầng</label>
            <select id="floorSelect" name="floor" class="form-select form-select-sm" style="min-width:120px;">
                @foreach (var f in floors.OrderBy(x => x))
                {
                    <option value="@f" @(f == selectedFloor ? "selected" : "")>@(f == 0 ? "G (0)" : "Tầng " + f)</option>
                }
            </select>
        </form>
        <a class="btn btn-sm btn-outline-secondary ms-2" href="@Url.Action("Index","Map", new { area = "Client", floor = selectedFloor })">Làm mới</a>
        <a class="btn btn-sm btn-outline-primary ms-1" href="@Url.Action("Index3D","Map", new { area = "Client", floor = selectedFloor })">3D View</a>
    </div>
</div>

<div class="card p-3">
    @if (!floors.Any())
    {
        <div class="alert alert-warning">Không có tầng để hiển thị.</div>
    }

    @foreach (var floor in floors.OrderBy(x => x))
    {
        var floorPositions = positions.Where(p => p.TenantPosition_Floor == floor).ToList();
        bool isGround = (floor == 0 || floor == 1);

        var topRow = floorPositions.Where(p => (p.TenantPosition_TopPct ?? 0m) < 50m).OrderBy(p => (p.TenantPosition_LeftPct ?? 0m)).ToList();
        var bottomRow = floorPositions.Where(p => (p.TenantPosition_TopPct ?? 0m) >= 50m).OrderBy(p => (p.TenantPosition_LeftPct ?? 0m)).ToList();
        var withoutCoords = floorPositions.Where(p => !p.TenantPosition_LeftPct.HasValue || !p.TenantPosition_TopPct.HasValue).ToList();

        List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto> ChunkOrFill(List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto> list, int skip)
        {
            var chunk = list.Skip(skip).Take(5).ToList();
            if (chunk.Count < 5 && withoutCoords.Any())
            {
                var need = 5 - chunk.Count;
                var extras = withoutCoords.Take(need).ToList();
                chunk.AddRange(extras);
                foreach (var e in extras) withoutCoords.Remove(e);
            }
            return chunk;
        }

        var topChunk1 = ChunkOrFill(topRow, 0);
        var topChunk2 = ChunkOrFill(topRow, 5);
        var topChunk3 = ChunkOrFill(topRow, 10);
        var topChunk4 = ChunkOrFill(topRow, 15);

        var botChunk1 = ChunkOrFill(bottomRow, 0);
        var botChunk2 = ChunkOrFill(bottomRow, 5);
        var botChunk3 = ChunkOrFill(bottomRow, 10);
        var botChunk4 = ChunkOrFill(bottomRow, 15);

        var hiddenStyle = floor == selectedFloor ? "" : "display:none;";
        <div class="floor-wrapper" data-floor="@floor" style="@hiddenStyle">
            <div class="d-flex justify-content-between align-items-end mb-1">
                <div>
                    <h5 class="m-0 font-weight-bold text-primary text-uppercase">Floor @floor @(isGround ? "(Ground Level)" : "")</h5>
                    <small class="text-muted">Diện tích tầng: @Model.FloorAreaM2 m² · Dành riêng: @Model.ReservedAreaM2 m² · Diện tích ô: @Model.PositionAreaM2 m²</small>
                </div>
                <div><small class="text-muted">Occupancy: @floorPositions.Count(x => x.TenantPosition_Status == 1) / @defaultCapacityPerFloor Units</small></div>
            </div>

            <div class="map-viewport" id="viewport-@floor">
                <div class="map-controls" data-floor="@floor">
                    <button class="map-zoom-out" title="Zoom out">-</button>
                    <button class="map-zoom-reset" title="Reset">⟳</button>
                    <button class="map-zoom-in" title="Zoom in">+</button>
                </div>

                <div class="map-content" id="map-content-@floor" data-floor="@floor">
                    <div class="floor-layout">
                        <div class="shop-strip">
                            <div class="end-cap">Exit</div>

                            <div class="shop-cluster">
                                @foreach (var pos in topChunk1)
                                {
                                    var css = pos.TenantPosition_Status == 1 ? "shop-unit unit-occupied" : "shop-unit unit-vacant";
                                    <a href="@Url.Action("Details","Map", new { area="Client", id = pos.TenantPosition_ID })" class="@css" title="@pos.TenantPosition_Location" data-id="@pos.TenantPosition_ID">
                                        <div class="shop-thumb">
                                            @{
                                                var img = pos.Tenant?.Tenant_Img;
                                                if (!string.IsNullOrWhiteSpace(img))
                                                {
                                                    var src = img.StartsWith("wwwroot/") ? "/" + img.Substring("wwwroot/".Length) : img;
                                                    <img src="@src" alt="@pos.Tenant?.Tenant_Name" />
                                                }
                                                else
                                                {
                                                    <span style="font-size:0.8rem;">@pos.TenantPosition_ID</span>
                                                }
                                            }
                                        </div>
                                        <div class="shop-location">@pos.TenantPosition_Location</div>
                                        <div class="shop-status">@((pos.TenantPosition_Status == 1 && pos.Tenant != null) ? pos.Tenant.Tenant_Name : "VACANT")</div>
                                    </a>
                                }
                                @for (int i = 0; i < (5 - topChunk1.Count); i++)
                                {
                                    <div class="unit-void"></div>
                                }
                            </div>

                            <div class="util-block-inner util-wc" style="background:#36b9cc; color:#fff; min-width:72px;">
                                <i class="fas fa-restroom" style="font-size:18px; margin-bottom:4px;"></i>
                                <div style="font-size:0.78rem;">WC</div>
                            </div>

                            <div class="shop-cluster">
                                @foreach (var pos in topChunk2)
                                {
                                    var css = pos.TenantPosition_Status == 1 ? "shop-unit unit-occupied" : "shop-unit unit-vacant";
                                    <a href="@Url.Action("Details","Map", new { area="Client", id = pos.TenantPosition_ID })" class="@css" title="@pos.TenantPosition_Location" data-id="@pos.TenantPosition_ID">
                                        <div class="shop-thumb">
                                            @{
                                                var img = pos.Tenant?.Tenant_Img;
                                                if (!string.IsNullOrWhiteSpace(img))
                                                {
                                                    var src = img.StartsWith("wwwroot/") ? "/" + img.Substring("wwwroot/".Length) : img;
                                                    <img src="@src" alt="@pos.Tenant?.Tenant_Name" />
                                                }
                                                else
                                                {
                                                    <span style="font-size:0.8rem;">@pos.TenantPosition_ID</span>
                                                }
                                            }
                                        </div>
                                        <div class="shop-location">@pos.TenantPosition_Location</div>
                                        <div class="shop-status">@((pos.TenantPosition_Status == 1 && pos.Tenant != null) ? pos.Tenant.Tenant_Name : "VACANT")</div>
                                    </a>
                                }
                                @for (int i = 0; i < (5 - topChunk2.Count); i++)
                                {
                                    <div class="unit-void"></div>
                                }
                            </div>

                            @if (isGround)
                            {
                                <div class="gate-center" style="width:64px; min-height:72px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                                    <i class="fas fa-arrow-down" style="font-size:18px;"></i>
                                    <div style="font-size:0.7rem; margin-top:4px;">NORTH</div>
                                </div>
                            }
                            else
                            {
                                <div class="util-block-inner" style="background-color:#4e73df; color:white; min-width:72px;">
                                    <i class="fas fa-map-marked-alt" style="font-size:18px;"></i>
                                    <div style="font-size:0.66rem; margin-top:4px;">INFO MAP</div>
                                </div>
                            }

                            <div class="shop-cluster">
                                @foreach (var pos in topChunk3)
                                {
                                    var css = pos.TenantPosition_Status == 1 ? "shop-unit unit-occupied" : "shop-unit unit-vacant";
                                    <a href="@Url.Action("Details","Map", new { area="Client", id = pos.TenantPosition_ID })" class="@css" title="@pos.TenantPosition_Location" data-id="@pos.TenantPosition_ID">
                                        <div class="shop-thumb">
                                            @{
                                                var img = pos.Tenant?.Tenant_Img;
                                                if (!string.IsNullOrWhiteSpace(img))
                                                {
                                                    var src = img.StartsWith("wwwroot/") ? "/" + img.Substring("wwwroot/".Length) : img;
                                                    <img src="@src" alt="@pos.Tenant?.Tenant_Name" />
                                                }
                                                else
                                                {
                                                    <span style="font-size:0.8rem;">@pos.TenantPosition_ID</span>
                                                }
                                            }
                                        </div>
                                        <div class="shop-location">@pos.TenantPosition_Location</div>
                                        <div class="shop-status">@((pos.TenantPosition_Status == 1 && pos.Tenant != null) ? pos.Tenant.Tenant_Name : "VACANT")</div>
                                    </a>
                                }
                                @for (int i = 0; i < (5 - topChunk3.Count); i++)
                                {
                                    <div class="unit-void"></div>
                                }
                            </div>

                            <div class="util-block-inner util-wc" style="background:#36b9cc; color:#fff; min-width:72px;"><i class="fas fa-restroom" style="font-size:18px; margin-bottom:4px;"></i><div style="font-size:0.78rem;">WC</div></div>

                            <div class="shop-cluster">
                                @foreach (var pos in topChunk4)
                                {
                                    var css = pos.TenantPosition_Status == 1 ? "shop-unit unit-occupied" : "shop-unit unit-vacant";
                                    <a href="@Url.Action("Details","Map", new { area="Client", id = pos.TenantPosition_ID })" class="@css" title="@pos.TenantPosition_Location" data-id="@pos.TenantPosition_ID">
                                        <div class="shop-thumb">
                                            @{
                                                var img = pos.Tenant?.Tenant_Img;
                                                if (!string.IsNullOrWhiteSpace(img))
                                                {
                                                    var src = img.StartsWith("wwwroot/") ? "/" + img.Substring("wwwroot/".Length) : img;
                                                    <img src="@src" alt="@pos.Tenant?.Tenant_Name" />
                                                }
                                                else
                                                {
                                                    <span style="font-size:0.8rem;">@pos.TenantPosition_ID</span>
                                                }
                                            }
                                        </div>
                                        <div class="shop-location">@pos.TenantPosition_Location</div>
                                        <div class="shop-status">@((pos.TenantPosition_Status == 1 && pos.Tenant != null) ? pos.Tenant.Tenant_Name : "VACANT")</div>
                                    </a>
                                }
                                @for (int i = 0; i < (5 - topChunk4.Count); i++)
                                {
                                    <div class="unit-void"></div>
                                }
                            </div>

                            <div class="end-cap" style="transform:rotate(180deg);">Exit</div>
                        </div> <!-- shop-strip -->

                        <div class="hallway" style="height:64px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; background:#f8f9fc; border-top:1px dashed #d1d3e2; border-bottom:1px dashed #d1d3e2;">
                            <div style="width:80px; text-align:center;">
                                @if (isGround)
                                {
                                    <span style="font-weight:bold; color:#e74a3b;"><i class="fas fa-chevron-right"></i> WEST</span>
                                }
                            </div>

                            <div class="escalator-group" title="Escalator & Stairs" style="display:flex; align-items:center; gap:8px; padding:6px 12px; border-radius:30px; background:#e9eef6; border:1px solid #d1d3e2;">
                                <i class="fas fa-level-up-alt"></i>
                                <div style="text-align:center;"><div style="font-size:0.6rem;">ESCALATOR</div><div style="font-size:0.52rem;">& STAIRS</div></div>
                                <i class="fas fa-level-down-alt"></i>
                            </div>

                            <div style="font-weight:700; color:#6c757d;">MAIN CORRIDOR (210m)</div>

                            <div class="escalator-group" title="Escalator & Stairs" style="display:flex; align-items:center; gap:8px; padding:6px 12px; border-radius:30px; background:#e9eef6; border:1px solid #d1d3e2;">
                                <i class="fas fa-level-up-alt"></i>
                                <div style="text-align:center;"><div style="font-size:0.6rem;">ESCALATOR</div><div style="font-size:0.52rem;">& STAIRS</div></div>
                                <i class="fas fa-level-down-alt"></i>
                            </div>

                            <div style="width:80px; text-align:center;">
                                @if (isGround)
                                {
                                    <span style="font-weight:bold; color:#e74a3b;">EAST <i class="fas fa-chevron-left"></i></span>
                                }
                            </div>
                        </div> <!-- hallway -->
                        <!-- BOTTOM ROW (same structure as TOP) -->
                        <div class="shop-strip">
                            <div class="end-cap">Exit</div>

                            <div class="shop-cluster">
                                @foreach (var pos in botChunk1)
                                {
                                    var css = pos.TenantPosition_Status == 1 ? "shop-unit unit-occupied" : "shop-unit unit-vacant";
                                    <a href="@Url.Action("Details","Map", new { area="Client", id = pos.TenantPosition_ID })" class="@css" title="@pos.TenantPosition_Location" data-id="@pos.TenantPosition_ID">
                                        <div class="shop-thumb">
                                            @{
                                                var img = pos.Tenant?.Tenant_Img;
                                                if (!string.IsNullOrWhiteSpace(img))
                                                {
                                                    var src = img.StartsWith("wwwroot/") ? "/" + img.Substring("wwwroot/".Length) : img;
                                                    <img src="@src" alt="@pos.Tenant?.Tenant_Name" />
                                                }
                                                else
                                                {
                                                    <span style="font-size:0.8rem;">@pos.TenantPosition_ID</span>
                                                }
                                            }
                                        </div>
                                        <div class="shop-location">@pos.TenantPosition_Location</div>
                                        <div class="shop-status">@((pos.TenantPosition_Status == 1 && pos.Tenant != null) ? pos.Tenant.Tenant_Name : "VACANT")</div>
                                    </a>
                                }
                                @for (int i = 0; i < (5 - botChunk1.Count); i++)
                                {
                                    <div class="unit-void"></div>
                                }
                            </div>

                            <div class="util-block-inner util-lift" style="background:#f6c23e; color:#222; min-width:72px;"><i class="fas fa-elevator" style="font-size:18px; color:#333"></i><div style="color:#333; font-size:0.75rem; margin-top:4px;">LIFT</div></div>

                            <div class="shop-cluster">
                                @foreach (var pos in botChunk2)
                                {
                                    var css = pos.TenantPosition_Status == 1 ? "shop-unit unit-occupied" : "shop-unit unit-vacant";
                                    <a href="@Url.Action("Details","Map", new { area="Client", id = pos.TenantPosition_ID })" class="@css" title="@pos.TenantPosition_Location" data-id="@pos.TenantPosition_ID">
                                        <div class="shop-thumb">
                                            @{
                                                var img = pos.Tenant?.Tenant_Img;
                                                if (!string.IsNullOrWhiteSpace(img))
                                                {
                                                    var src = img.StartsWith("wwwroot/") ? "/" + img.Substring("wwwroot/".Length) : img;
                                                    <img src="@src" alt="@pos.Tenant?.Tenant_Name" />
                                                }
                                                else
                                                {
                                                    <span style="font-size:0.8rem;">@pos.TenantPosition_ID</span>
                                                }
                                            }
                                        </div>
                                        <div class="shop-location">@pos.TenantPosition_Location</div>
                                        <div class="shop-status">@((pos.TenantPosition_Status == 1 && pos.Tenant != null) ? pos.Tenant.Tenant_Name : "VACANT")</div>
                                    </a>
                                }
                                @for (int i = 0; i < (5 - botChunk2.Count); i++)
                                {
                                    <div class="unit-void"></div>
                                }
                            </div>

                            @if (isGround)
                            {
                                <div class="gate-center" style="width:64px; min-height:72px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center;"><div style="font-weight:700;">SOUTH</div><i class="fas fa-arrow-up" style="font-size:18px; margin-top:6px;"></i></div>
                            }
                            else
                            {
                                <div class="util-block-inner" style="background-color:#17a2b8; color:white; min-width:72px;"><i class="fas fa-couch"></i><div style="font-size:0.66rem; margin-top:4px;">LOUNGE</div></div>
                            }

                            <div class="shop-cluster">
                                @foreach (var pos in botChunk3)
                                {
                                    var css = pos.TenantPosition_Status == 1 ? "shop-unit unit-occupied" : "shop-unit unit-vacant";
                                    <a href="@Url.Action("Details","Map", new { area="Client", id = pos.TenantPosition_ID })" class="@css" title="@pos.TenantPosition_Location" data-id="@pos.TenantPosition_ID">
                                        <div class="shop-thumb">
                                            @{
                                                var img = pos.Tenant?.Tenant_Img;
                                                if (!string.IsNullOrWhiteSpace(img))
                                                {
                                                    var src = img.StartsWith("wwwroot/") ? "/" + img.Substring("wwwroot/".Length) : img;
                                                    <img src="@src" alt="@pos.Tenant?.Tenant_Name" />
                                                }
                                                else
                                                {
                                                    <span style="font-size:0.8rem;">@pos.TenantPosition_ID</span>
                                                }
                                            }
                                        </div>
                                        <div class="shop-location">@pos.TenantPosition_Location</div>
                                        <div class="shop-status">@((pos.TenantPosition_Status == 1 && pos.Tenant != null) ? pos.Tenant.Tenant_Name : "VACANT")</div>
                                    </a>
                                }
                                @for (int i = 0; i < (5 - botChunk3.Count); i++)
                                {
                                    <div class="unit-void"></div>
                                }
                            </div>

                            <div class="util-block-inner util-lift" style="background:#f6c23e; color:#222; min-width:72px;"><i class="fas fa-elevator" style="font-size:18px; color:#333"></i><div style="color:#333; font-size:0.75rem; margin-top:4px;">LIFT</div></div>

                            <div class="shop-cluster">
                                @foreach (var pos in botChunk4)
                                {
                                    var css = pos.TenantPosition_Status == 1 ? "shop-unit unit-occupied" : "shop-unit unit-vacant";
                                    <a href="@Url.Action("Details","Map", new { area="Client", id = pos.TenantPosition_ID })" class="@css" title="@pos.TenantPosition_Location" data-id="@pos.TenantPosition_ID">
                                        <div class="shop-thumb">
                                            @{
                                                var img = pos.Tenant?.Tenant_Img;
                                                if (!string.IsNullOrWhiteSpace(img))
                                                {
                                                    var src = img.StartsWith("wwwroot/") ? "/" + img.Substring("wwwroot/".Length) : img;
                                                    <img src="@src" alt="@pos.Tenant?.Tenant_Name" />
                                                }
                                                else
                                                {
                                                    <span style="font-size:0.8rem;">@pos.TenantPosition_ID</span>
                                                }
                                            }
                                        </div>
                                        <div class="shop-location">@pos.TenantPosition_Location</div>
                                        <div class="shop-status">@((pos.TenantPosition_Status == 1 && pos.Tenant != null) ? pos.Tenant.Tenant_Name : "VACANT")</div>
                                    </a>
                                }
                                @for (int i = 0; i < (5 - botChunk4.Count); i++)
                                {
                                    <div class="unit-void"></div>
                                }
                            </div>

                            <div class="end-cap" style="transform:rotate(180deg);">Exit</div>
                        </div> <!-- bottom strip -->

                    </div> <!-- floor-layout -->
                </div> <!-- map-content -->
            </div> <!-- map-viewport -->
        </div> <!-- floor-wrapper -->
    } <!-- foreach floors -->
</div> <!-- card -->
@section Scripts {
    <script>
        (function(){
            // floor select submit
            var sel = document.getElementById('floorSelect');
            if (sel) sel.addEventListener('change', function(){ document.getElementById('floorSelectForm').submit(); });

            // tabs: show/hide floors client-side
            document.querySelectorAll('.floor-tab').forEach(function(t){
                t.addEventListener('click', function(e){
                    e.preventDefault();
                    var f = this.getAttribute('data-floor');
                    document.querySelectorAll('.floor-tab').forEach(x=>x.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.floor-wrapper').forEach(function(w){
                        w.style.display = (w.getAttribute('data-floor') === f) ? '' : 'none';
                    });
                    // fit visible floor after toggle
                    setTimeout(function(){ fitMapToViewport(f); }, 80);
                });
            });

            // MapController (pan + zoom) - improved centering & fit
            var controllers = {};
            function MapController(viewportEl, contentEl) {
                this.v = viewportEl; this.c = contentEl;
                if(!this.v||!this.c) return;
                this.scale = 1; this.tx = 0; this.ty = 0; this.dragging=false; this.lastX=0; this.lastY=0;
                this.apply = function(){ this.c.style.transform = 'translate(' + this.tx + 'px, ' + this.ty + 'px) scale(' + this.scale + ')'; };
                this.reset = function(){ this.scale=1; this.tx=0; this.ty=0; this.apply(); };
                this.zoomBy = function(factor, cx, cy){
                    var old = this.scale;
                    var newScale = Math.max(0.4, Math.min(2.6, this.scale * factor));
                    if (typeof cx === 'number') {
                        var rect = this.v.getBoundingClientRect();
                        var localX = cx - rect.left; var localY = cy - rect.top;
                        this.tx = localX - ((localX - this.tx) * (newScale/old));
                        this.ty = localY - ((localY - this.ty) * (newScale/old));
                    } else {
                        var r = this.v.getBoundingClientRect();
                        var localX = r.width/2, localY = r.height/2;
                        this.tx = localX - ((localX - this.tx) * (newScale/old));
                        this.ty = localY - ((localY - this.ty) * (newScale/old));
                    }
                    this.scale = newScale; this.apply();
                };
                var self=this;
                // wheel zoom (Ctrl not required)
                this.v.addEventListener('wheel', function(e){ e.preventDefault(); var f = e.deltaY>0?0.92:1.08; self.zoomBy(f, e.clientX, e.clientY); }, {passive:false});
                // drag
                this.c.addEventListener('mousedown', function(e){ if(e.target.closest('a')) return; e.preventDefault(); self.dragging=true; self.lastX=e.clientX; self.lastY=e.clientY; });
                window.addEventListener('mousemove', function(e){ if(!self.dragging) return; var dx=e.clientX-self.lastX, dy=e.clientY-self.lastY; self.lastX=e.clientX; self.lastY=e.clientY; self.tx+=dx; self.ty+=dy; self.apply(); });
                window.addEventListener('mouseup', function(){ self.dragging=false; });
                // simple touch gestures (pan + pinch)
                var lastDist=null;
                this.v.addEventListener('touchstart', function(e){ if(e.touches.length===1){ self.dragging=true; self.lastX=e.touches[0].clientX; self.lastY=e.touches[0].clientY;} else if(e.touches.length===2){ lastDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); } }, {passive:false});
                this.v.addEventListener('touchmove', function(e){ if(e.touches.length===1 && self.dragging){ var dx = e.touches[0].clientX - self.lastX; var dy = e.touches[0].clientY - self.lastY; self.lastX=e.touches[0].clientX; self.lastY=e.touches[0].clientY; self.tx+=dx; self.ty+=dy; self.apply(); } else if(e.touches.length===2 && lastDist){ var dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); var f = dist/lastDist; self.zoomBy(f); lastDist = dist; } }, {passive:false});
                this.v.addEventListener('touchend', function(){ lastDist=null; self.dragging=false; });
            }

            function initControllers(){
                document.querySelectorAll('.map-content').forEach(function(c){
                    var floor = c.getAttribute('data-floor');
                    var vp = document.getElementById('viewport-' + floor);
                    if (!vp) return;
                    var ctrl = new MapController(vp, c);
                    controllers[floor] = ctrl;
                    var pc = vp.querySelector('.map-controls');
                    pc.querySelector('.map-zoom-in')?.addEventListener('click', function(){ ctrl.zoomBy(1.12); });
                    pc.querySelector('.map-zoom-out')?.addEventListener('click', function(){ ctrl.zoomBy(0.88); });
                    pc.querySelector('.map-zoom-reset')?.addEventListener('click', function(){ ctrl.reset(); fitMapToViewport(floor); });
                });
            }

            // fit content to viewport: calculate scale so content fits (no horizontal overflow)
            function fitMapToViewport(floor){
                var c = document.getElementById('map-content-' + floor);
                var v = document.getElementById('viewport-' + floor);
                var ctrl = controllers[floor];
                if (!c || !v || !ctrl) return;

                // temporarily clear transforms to measure true size
                c.style.transform = 'none';
                var contentW = c.getBoundingClientRect().width;
                var contentH = c.getBoundingClientRect().height;
                var viewRect = v.getBoundingClientRect();
                var vw = viewRect.width - 20; // leave some padding
                var vh = viewRect.height - 20;

                // compute scale to fit both width and height, but don't scale up beyond 1
                var scaleW = vw / contentW;
                var scaleH = vh / contentH;
                var scale = Math.min(1, Math.max(0.45, Math.min(scaleW, scaleH)));

                // center content in viewport
                ctrl.scale = scale;
                ctrl.tx = ( (viewRect.width) - (contentW * scale) ) / 2;
                ctrl.ty = ( (viewRect.height) - (contentH * scale) ) / 2;
                ctrl.apply();
            }

            initControllers();

            // initial fit for visible floor(s)
            setTimeout(function(){
                Object.keys(controllers).forEach(function(k){
                    // only fit visible floor (not display:none)
                    var wrapper = document.querySelector('.floor-wrapper[data-floor="'+k+'"]');
                    if (!wrapper) return;
                    if (getComputedStyle(wrapper).display === 'none') return;
                    fitMapToViewport(k);
                });
            }, 140);

            // global controls
            document.getElementById('globalZoomIn')?.addEventListener('click', function(){ Object.keys(controllers).forEach(k=>controllers[k] && controllers[k].zoomBy(1.12)); });
            document.getElementById('globalZoomOut')?.addEventListener('click', function(){ Object.keys(controllers).forEach(k=>controllers[k] && controllers[k].zoomBy(0.88)); });
            document.getElementById('globalZoomReset')?.addEventListener('click', function(){ Object.keys(controllers).forEach(k=>controllers[k] && controllers[k].reset()); Object.keys(controllers).forEach(k=>fitMapToViewport(k)); });

            // on resize, refit visible map(s)
            var resizeTimer;
            window.addEventListener('resize', function(){ clearTimeout(resizeTimer); resizeTimer = setTimeout(function(){ Object.keys(controllers).forEach(k=>fitMapToViewport(k)); }, 160); });
        })();
    </script>
}
