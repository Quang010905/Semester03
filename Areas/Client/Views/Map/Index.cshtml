@model Semester03.Areas.Client.Models.ViewModels.MapViewModel

@{
    ViewData["Title"] = "Mall Floor Plan — Tube Layout";
    Layout = "~/Areas/Client/Views/Shared/_LayoutClient.cshtml";

    int defaultCapacity = 40;
    var floors = Model?.AvailableFloors ?? new List<int> { Model.FloorNumber };
    var selectedFloor = Model?.FloorNumber ?? floors.FirstOrDefault();
    var positions = Model?.Positions ?? new List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto>();
}

@section Styles {
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        * {
            box-sizing: border-box;
        }

        /* ---------- HEADER ---------- */
        .map-header h1 {
            font-weight: 800;
            font-size: 1.9rem;
            background: linear-gradient(90deg,#0d6efd,#4f46e5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .map-header small {
            font-size: .85rem;
            color: #6b7280;
        }

        /* ---------- FLOOR TABS ---------- */
        .floors-toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 14px 0;
        }

        .floor-tab {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid #d1d5db;
            background: #f8fafc;
            font-weight: 600;
            cursor: pointer;
            transition: .15s;
        }

            .floor-tab:hover {
                background: #e7eeff;
            }

            .floor-tab.active {
                background: #0d6efd;
                border-color: #0d6efd;
                color: #ffffff;
            }

        /* ---------- FLOOR WRAPPER ---------- */
        .floor-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: 0 10px 26px rgba(0,0,0,0.06);
        }

        /* ---------- LAYOUT ---------- */
        .floor-layout {
            display: flex;
            flex-direction: column;
            min-width: 1400px;
            background: #f3f4f6;
            padding: 8px;
            border: 2px solid #d1d5db;
        }

        .shop-strip {
            display: flex;
            min-height: 82px;
            gap: 2px;
        }

        /* ---------- SHOP CLUSTER (5 units) ---------- */
        .shop-cluster {
            flex: 5;
            display: flex;
            gap: 1px;
        }

        /* ---------- EXIT BLOCK ---------- */
        .end-cap {
            width: 42px;
            background: #ef4444;
            color: #ffffff;
            border: 1px solid #b91c1c;
            writing-mode: vertical-lr;
            font-size: .7rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
        }

        /* ---------- UTIL BLOCKS ---------- */
        .util-block {
            flex: 1;
            min-width: 70px;
            background: #4b5563;
            color: #ffffff;
            border-left: 2px solid #ffffff;
            border-right: 2px solid #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: .65rem;
            font-weight: 700;
        }

        .util-wc {
            background: #36b9cc !important;
        }

        .util-lift {
            background: #f6c23e !important;
            color: #333 !important;
        }

        .util-info {
            background: #4e73df !important;
        }

        /* ---------- GATE ---------- */
        .gate-center {
            flex: 1;
            min-width: 60px;
            background: #ffffff;
            text-align: center;
            font-size: .65rem;
            font-weight: 800;
            color: #e74a3b;
            border-left: 2px dashed #e74a3b;
            border-right: 2px dashed #e74a3b;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* ---------- HALLWAY ---------- */
        .hallway {
            height: 60px;
            background: #f8fafc;
            border-top: 1px dashed #d1d3e2;
            border-bottom: 1px dashed #d1d3e2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            font-weight: 700;
            font-size: .75rem;
        }

        .escalator-group {
            display: flex;
            align-items: center;
            background: #e2e6ea;
            padding: 5px 15px;
            border-radius: 30px;
            border: 1px solid #d1d3e2;
            color: #374151;
            font-weight: 600;
            gap: 6px;
        }

        /* ---------- SHOP UNITS ---------- */
        .shop-unit {
            flex: 1;
            min-width: 45px;
            background: #ffffff;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 6px;
            text-align: center;
            font-size: .65rem;
            text-decoration: none;
            color: #333;
            transition: .15s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

            .shop-unit:hover {
                transform: scale(1.1);
                z-index: 10;
                border-color: #0d6efd;
                box-shadow: 0 0 10px rgba(0,0,0,0.2);
            }

        .unit-vacant {
            background: #e8fce8;
            color: #14532d;
        }

        .unit-occupied {
            background: #d9ecff;
            color: #0c4a6e;
        }

        .unit-void {
            border: 1px dashed #d1d3e2 !important;
            background: transparent !important;
        }

        .unit-title {
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unit-tenant {
            font-size: .65rem;
            color: #6b7280;
        }

        /* ---------- OVERLAY PANEL ---------- */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

            .overlay.visible {
                display: flex;
            }

        .panel {
            background: #ffffff;
            width: 680px;
            max-width: 95%;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
            padding: 20px;
            transform: translateY(20px);
            opacity: 0;
            transition: .2s ease;
            max-height: 88vh;
            overflow: auto;
        }

            .panel.visible {
                transform: translateY(0);
                opacity: 1;
            }

            .panel .hdr {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

                .panel .hdr h4 {
                    margin: 0;
                    font-weight: 700;
                    font-size: 1.1rem;
                }

        .close-btn {
            border: 0;
            background: 0;
            font-size: 1.3rem;
            color: #555;
            cursor: pointer;
        }

        .tenant-row {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }

        .tenant-img {
            width: 140px;
            height: 100px;
            background: #f3f4f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .no-shop {
            padding: 24px;
            text-align: center;
            font-weight: 600;
            color: #6b7280;
        }
    </style>
}

<!-- HEADER -->
<div class="map-header mb-3">
    <h1>Mall Floor Plan</h1>
    <small>Browse tenants + facilities by floor</small>
</div>

@if (!floors.Any())
{
    <div class="alert alert-warning">No floors available.</div>
}

@functions {
    List<List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto>> Chunk5(List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto> src)
    {
        var list = new List<List<Semester03.Areas.Client.Models.ViewModels.TenantPositionDto>>();
        if (src == null) return list;
        for (int i = 0; i < src.Count; i += 5)
            list.Add(src.Skip(i).Take(5).ToList());
        return list;
    }
}

<!-- FLOOR TABS -->
<div class="floors-toolbar">
    @foreach (var f in floors.OrderBy(x => x))
    {
        var cls = f == selectedFloor ? "floor-tab active" : "floor-tab";
        <div class="@cls" data-floor="@f">@(f == 0 ? "Ground Floor" : $"Floor {f}")</div>
    }
</div>

<!-- FLOOR LAYOUT -->
@foreach (var floor in floors.OrderBy(x => x))
{
    var list = positions.Where(p => p.TenantPosition_Floor == floor).ToList();

    var top = list.Where(p => (p.TenantPosition_TopPct ?? 0) < 50)
                  .OrderBy(p => p.TenantPosition_LeftPct).ToList();

    var bottom = list.Where(p => (p.TenantPosition_TopPct ?? 0) >= 50)
                     .OrderBy(p => p.TenantPosition_LeftPct).ToList();

    var topClusters = Chunk5(top);
    var bottomClusters = Chunk5(bottom);

    <div class="floor-card" data-floor="@floor" style="@(floor == selectedFloor ? "" : "display:none;")">

        <div class="d-flex justify-content-between align-items-end mb-2">
            <div>
                <h5 class="fw-bold mb-1">@((floor == 0) ? "Ground Floor" : $"Floor {floor}")</h5>
                <small class="text-muted">
                    Floor area: @Model.FloorAreaM2 m² ● Reserved: @Model.ReservedAreaM2 m² ● Unit area: @Model.PositionAreaM2 m²
                </small>
            </div>

            <small class="text-muted">
                Occupied: @list.Count(x => x.TenantPosition_Status == 1) / @defaultCapacity units
            </small>
        </div>

        <!-- REAL-FLOOR STRUCTURE -->
        <div class="floor-layout">

            <!-- TOP STRIP -->
            <div class="shop-strip">

                <div class="end-cap">EXIT</div>

                @foreach (var cluster in topClusters)
                {
                    <div class="shop-cluster">
                        @foreach (var pos in cluster)
                        {
                            bool occ = pos.TenantPosition_Status == 1;
                            var tenantName = pos.Tenant?.Tenant_Name ?? "";
                            var tenantImg = pos.Tenant?.Tenant_Img ?? "";
                            var desc = pos.Tenant?.Tenant_Description ?? "";
                            var loc = pos.TenantPosition_Location ?? "";
                            var area = pos.TenantPosition_Area_M2.ToString("0.#");
                            int? tenantId = pos.Tenant?.Tenant_Id;

                            <a href="#"
                               class="shop-unit @(occ ? "unit-occupied" : "unit-vacant")"
                               data-tenant-name="@tenantName"
                               data-tenant-img="@tenantImg"
                               data-tenant-desc="@desc"
                               data-location="@loc"
                               data-floor="@floor"
                               data-area="@area"
                               data-status="@pos.TenantPosition_Status"
                               data-details-url="@(occ && tenantId.HasValue
                              ? Url.Action("Details", "Stores", new { area = "Client", id = tenantId.Value })
                              : "")">

                                <div class="unit-title">@(!string.IsNullOrEmpty(loc) ? loc : $"Unit {pos.TenantPosition_ID}")</div>
                                <div class="unit-tenant">@((occ ? tenantName : "Vacant"))</div>
                            </a>
                        }
                        @for (int i = cluster.Count; i < 5; i++)
                        {
                            <div class="shop-unit unit-void"></div>
                        }
                    </div>
                }

                <div class="util-block util-wc">
                    <i class="fas fa-restroom util-icon"></i>
                    <div>WC</div>
                </div>

                <div class="end-cap" style="transform:rotate(180deg);">EXIT</div>
            </div>

            <!-- CENTRAL HALLWAY -->
            <div class="hallway">
                <span style="color:#dc2626;">WEST</span>

                <div class="escalator-group">
                    <i class="fas fa-level-up-alt escalator-icon"></i>
                    <div style="line-height:1;">
                        <span style="font-size:.65rem;">ESCALATOR</span><br />
                        <span style="font-size:.55rem;">& STAIRS</span>
                    </div>
                    <i class="fas fa-level-down-alt escalator-icon"></i>
                </div>

                <span>MAIN CORRIDOR (210m)</span>

                <div class="escalator-group">
                    <i class="fas fa-level-up-alt escalator-icon"></i>
                    <div style="line-height:1;">
                        <span style="font-size:.65rem;">ESCALATOR</span><br />
                        <span style="font-size:.55rem;">& STAIRS</span>
                    </div>
                    <i class="fas fa-level-down-alt escalator-icon"></i>
                </div>

                <span style="color:#dc2626;">EAST</span>
            </div>

            <!-- BOTTOM STRIP -->
            <div class="shop-strip">

                <div class="end-cap">EXIT</div>

                @foreach (var cluster in bottomClusters)
                {
                    <div class="shop-cluster">
                        @foreach (var pos in cluster)
                        {
                            bool occ = pos.TenantPosition_Status == 1;
                            var tenantName = pos.Tenant?.Tenant_Name ?? "";
                            var tenantImg = pos.Tenant?.Tenant_Img ?? "";
                            var desc = pos.Tenant?.Tenant_Description ?? "";
                            var loc = pos.TenantPosition_Location ?? "";
                            var area = pos.TenantPosition_Area_M2.ToString("0.#");
                            int? tenantId = pos.Tenant?.Tenant_Id;

                            <a href="#"
                               class="shop-unit @(occ ? "unit-occupied" : "unit-vacant")"
                               data-tenant-name="@tenantName"
                               data-tenant-img="@tenantImg"
                               data-tenant-desc="@desc"
                               data-location="@loc"
                               data-floor="@floor"
                               data-area="@area"
                               data-status="@pos.TenantPosition_Status"
                               data-details-url="@(occ && tenantId.HasValue
                              ? Url.Action("Details", "Stores", new { area = "Client", id = tenantId.Value })
                              : "")">

                                <div class="unit-title">@(!string.IsNullOrEmpty(loc) ? loc : $"Unit {pos.TenantPosition_ID}")</div>
                                <div class="unit-tenant">@((occ ? tenantName : "Vacant"))</div>
                            </a>
                        }
                        @for (int i = cluster.Count; i < 5; i++)
                        {
                            <div class="shop-unit unit-void"></div>
                        }
                    </div>
                }

                <div class="util-block util-lift">
                    <i class="fas fa-elevator util-icon"></i>
                    <div>LIFT</div>
                </div>

                <div class="end-cap" style="transform:rotate(180deg);">EXIT</div>

            </div>

        </div>
    </div>
}

<!-- MODAL -->
<div id="tenantOverlay" class="overlay">
    <div id="tenantPanel" class="panel">
        <div class="hdr">
            <h4 id="panelTitle">Shop details</h4>
            <button class="close-btn" id="panelClose" aria-label="Close panel">&times;</button>
        </div>

        <div id="panelContent">
            <div id="noShop" class="no-shop">
                No tenant assigned for this unit.
            </div>

            <div id="tenantInfo" style="display:none;">
                <div class="tenant-row">
                    <div class="tenant-img" id="tenantImg"></div>
                    <div class="tenant-body">
                        <p id="tenantName" style="font-weight:800;font-size:1.05rem;margin-bottom:6px;"></p>
                        <p class="meta">Location: <span id="metaLocation"></span></p>
                        <p class="meta">Floor: <span id="metaFloor"></span></p>
                        <p class="meta">Area: <span id="metaArea"></span> m²</p>
                        <p class="meta">Status: <span id="metaStatus"></span></p>
                        <p id="tenantDesc" class="mt-2"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <a id="detailsLink"
               href="#"
               class="btn btn-sm btn-primary"
               style="display:none;">
                View store details
            </a>
            <button id="panelClose2" class="btn btn-sm btn-outline-secondary">
                Close
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {

            /* FLOOR TABS CLICK */
            const floorTabs  = document.querySelectorAll('.floor-tab');
            const floorCards = document.querySelectorAll('.floor-card');

            floorTabs.forEach(tab => {
                tab.addEventListener('click', function (e) {
                    e.preventDefault();
                    const floor = this.getAttribute('data-floor');

                    floorTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    floorCards.forEach(card => {
                        card.style.display = (card.getAttribute('data-floor') === floor) ? '' : 'none';
                    });
                });
            });

            /* OVERLAY / PANEL ELEMENTS */
            const overlay     = document.getElementById('tenantOverlay');
            const panel       = document.getElementById('tenantPanel');
            const btnClose    = document.getElementById('panelClose');
            const btnClose2   = document.getElementById('panelClose2');
            const panelTitle  = document.getElementById('panelTitle');
            const noShop      = document.getElementById('noShop');
            const tenantInfo  = document.getElementById('tenantInfo');
            const tenantImg   = document.getElementById('tenantImg');
            const tenantName  = document.getElementById('tenantName');
            const tenantDesc  = document.getElementById('tenantDesc');
            const metaLocation = document.getElementById('metaLocation');
            const metaFloor    = document.getElementById('metaFloor');
            const metaArea     = document.getElementById('metaArea');
            const metaStatus   = document.getElementById('metaStatus');
            const detailsLink  = document.getElementById('detailsLink');

            function openPanel() {
                if (!overlay || !panel) return;
                overlay.classList.add('visible');
                panel.classList.add('visible');
            }

            function closePanel() {
                if (!overlay || !panel) return;
                panel.classList.remove('visible');
                overlay.classList.remove('visible');
            }

            if (btnClose)  btnClose.addEventListener('click', closePanel);
            if (btnClose2) btnClose2.addEventListener('click', closePanel);

            if (overlay) {
                overlay.addEventListener('click', function (e) {
                    if (e.target === overlay) {
                        closePanel();
                    }
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closePanel();
                }
            });

            function normalizeImgPath(raw) {
                if (!raw) return '';
                let s = raw;

                if (s.indexOf('wwwroot/') === 0) {
                    s = '/' + s.substring('wwwroot/'.length);
                }
                // If already starts with http or / then just return
                if (s.startsWith('http')) return s;
                if (s.startsWith('/')) return s;

                // Otherwise treat as relative path from web root
                return '/' + s;
            }

            function populatePanelFromUnit(el) {
                if (!el) return;

                const name       = el.getAttribute('data-tenant-name') || '';
                const img        = el.getAttribute('data-tenant-img') || '';
                const desc       = el.getAttribute('data-tenant-desc') || '';
                const location   = el.getAttribute('data-location') || '';
                const floor      = el.getAttribute('data-floor') || '';
                const area       = el.getAttribute('data-area') || '';
                const status     = el.getAttribute('data-status') || '0';
                const detailsUrl = el.getAttribute('data-details-url') || '';

                if (!name.trim()) {
                    // no tenant
                    if (noShop)   noShop.style.display = '';
                    if (tenantInfo) tenantInfo.style.display = 'none';
                    if (detailsLink) detailsLink.style.display = 'none';
                    if (panelTitle) panelTitle.textContent = 'Vacant unit';
                    return;
                }

                // show tenant info
                if (noShop)     noShop.style.display = 'none';
                if (tenantInfo) tenantInfo.style.display = '';

                if (panelTitle) {
                    panelTitle.textContent = name + ' — shop details';
                }

                if (tenantImg) {
                    tenantImg.innerHTML = '';
                    if (img) {
                        const imgEl = document.createElement('img');
                        imgEl.src = normalizeImgPath(img);
                        imgEl.alt = name;
                        imgEl.style.maxWidth = '100%';
                        imgEl.style.maxHeight = '100%';
                        tenantImg.appendChild(imgEl);
                    } else {
                        tenantImg.textContent = location || 'Unit';
                    }
                }

                if (tenantName)   tenantName.textContent   = name;
                if (tenantDesc)   tenantDesc.textContent   = desc || 'No description.';
                if (metaLocation) metaLocation.textContent = location || '—';
                if (metaFloor)    metaFloor.textContent    = floor || '—';
                if (metaArea)     metaArea.textContent     = area || '—';
                if (metaStatus)   metaStatus.textContent   = (status === '1') ? 'Occupied' : 'Vacant';

                if (detailsLink) {
                    if (detailsUrl) {
                        detailsLink.style.display = '';
                        detailsLink.href = detailsUrl;
                    } else {
                        detailsLink.style.display = 'none';
                    }
                }
            }

            // CLICK ON SHOP UNIT
            document.addEventListener('click', function (e) {
                const unit = e.target.closest('.shop-unit');
                if (!unit) return;
                e.preventDefault();

                populatePanelFromUnit(unit);
                openPanel();
            });

        })();
    </script>
}
