@using System.Linq
@using Semester03.Areas.Client.Models.ViewModels
@model object

@{
    IEnumerable<EventCardVm> events = Enumerable.Empty<EventCardVm>();

    // 1) If model already EventCardVm list — use it directly
    if (Model is IEnumerable<EventCardVm> evs)
    {
        events = evs;
    }
    // 2) If model is some enumerable of objects/dynamics — map safely via reflection
    else if (Model is IEnumerable<object> objs)
    {
        events = objs.Select(o =>
        {
            if (o == null) return new EventCardVm { Id = 0, Title = "", ShortDescription = "", StartDate = null, ImageUrl = "/images/event-placeholder.png" };

            var t = o.GetType();
            object val;

            // Id
            int id = 0;
            var pId = t.GetProperty("Id") ?? t.GetProperty("EventId");
            if (pId != null && (val = pId.GetValue(o)) != null)
            {
                int.TryParse(val.ToString(), out id);
            }

            // Title
            string title = "";
            var pTitle = t.GetProperty("Title") ?? t.GetProperty("EventName");
            if (pTitle != null && (val = pTitle.GetValue(o)) != null)
                title = val.ToString();

            // ShortDescription
            string shortDesc = "";
            var pShort = t.GetProperty("ShortDescription") ?? t.GetProperty("Description") ?? t.GetProperty("EventDescription");
            if (pShort != null && (val = pShort.GetValue(o)) != null)
                shortDesc = val.ToString();

            // StartDate
            DateTime? start = null;
            var pStart = t.GetProperty("StartDate") ?? t.GetProperty("EventStart") ?? t.GetProperty("NextShowtime");
            if (pStart != null && (val = pStart.GetValue(o)) != null)
            {
                if (val is DateTime dt) start = dt;
                else
                {
                    if (DateTime.TryParse(val.ToString(), out DateTime parsed)) start = parsed;
                }
            }

            // ImageUrl
            string img = "/images/event-placeholder.png";
            var pImg = t.GetProperty("ImageUrl") ?? t.GetProperty("EventImg") ?? t.GetProperty("PosterUrl");
            if (pImg != null && (val = pImg.GetValue(o)) != null && !string.IsNullOrWhiteSpace(val.ToString()))
                img = val.ToString();

            return new EventCardVm
                    {
                        Id = id,
                        Title = title,
                        ShortDescription = shortDesc,
                        StartDate = start,
                        ImageUrl = img
                    };
        }).ToList();
    }
    else
    {
        events = Enumerable.Empty<EventCardVm>();
    }
}

<div class="list-group small">
    @if (events.Any())
    {
        foreach (var e in events)
        {
            var title = e?.Title ?? "Event";
            var start = e?.StartDate.HasValue == true ? e.StartDate.Value.ToString("dd MMM yyyy HH:mm") : "";
            <a href="@Url.Action("Details", "Event", new { area = "Client", id = e?.Id })" class="list-group-item list-group-item-action">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-truncate" style="max-width:180px;">@title</div>
                    <small class="text-muted">@start</small>
                </div>
                @if (!string.IsNullOrWhiteSpace(e?.ShortDescription))
                {
                    <div class="small text-muted ps-2 pe-2">@e.ShortDescription</div>
                }
            </a>
        }
    }
    else
    {
        <div class="text-center text-muted small p-3">
            <div>No upcoming items 🔕</div>
            <div class="mt-2">
                <a href="@Url.Action("Index", "Event", new { area = "Client" })" class="btn btn-sm btn-outline-primary">See all events</a>
            </div>
        </div>
    }
</div>
