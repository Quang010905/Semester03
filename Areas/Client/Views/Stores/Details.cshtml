@model Semester03.Models.ViewModels.TenantDetailsViewModel
@{
    Layout = "_LayoutClient";

    Func<string, string> Img = (raw) =>
    {
        if (string.IsNullOrWhiteSpace(raw))
            return Url.Content("~/Admin/img/store-placeholder.png"); // ảnh mặc định
        return Url.Content("~/Admin/img/" + raw); // ảnh tenant
    };

    var poster = Img(Model.TenantImg);
}

@section Styles {
    <style>
        .store-hero {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            align-items: start;
        }

        .store-poster {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(2,6,23,0.12);
        }

            .store-poster img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

        .store-meta {
            padding-top: .25rem;
        }

        .store-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: .25rem;
        }

        .store-sub {
            color: #6b7280;
            margin-bottom: .5rem;
        }

        .stars {
            display: flex;
            gap: .25rem;
            align-items: center;
        }

        .star {
            font-size: 1.4rem;
            cursor: pointer;
            color: #cbd5e1;
            display: inline-flex;
            align-items: center;
        }

            .star.active, .star.filled, .star.bi-star-fill {
                color: #ffc107;
                transform: scale(1.08);
            }

        .rate-badge {
            font-weight: 700;
            background: linear-gradient(90deg,#ffb347,#ffcc33);
            color: #111;
            padding: .25rem .6rem;
            border-radius: .5rem;
        }

        .comment-box {
            margin-top: 1rem;
            border-radius: .75rem;
            background: #fff;
            padding: 1rem;
            box-shadow: 0 6px 20px rgba(2,6,23,0.06);
        }

        .comment-item {
            border-bottom: 1px solid #f1f5f9;
            padding: .75rem 0;
        }

            .comment-item:last-child {
                border-bottom: none;
            }

        .comment-user {
            font-weight: 600;
            margin-right: .5rem;
        }

        .comment-time {
            color: #94a3b8;
            font-size: .85rem;
        }

        .btn-primary-ghost {
            background: linear-gradient(90deg,#0d6efd,#4f46e5);
            border: none;
            color: #fff;
            padding: .6rem 1rem;
            border-radius: .6rem;
            box-shadow: 0 8px 30px rgba(13,110,253,0.12);
        }

        @@media (max-width: 991px) {
            .store-hero

        {
            grid-template-columns: 1fr;
        }

        }
    </style>
}

<div class="py-3">
    <a class="btn btn-outline-secondary btn-sm mb-3" href="@Url.Action("Index","Stores", new { area = "Client" })">&larr; Back</a>

    <div class="store-hero">
        <div class="store-poster">
            <img src="@poster" alt="@Model.TenantName" />
        </div>

        <div class="store-meta">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="store-title">@Model.TenantName</div>
                    <div class="store-sub">@Model.TenantTypeName &middot; @Model.Position</div>
                    <p class="text-muted">@Model.TenantDescription</p>
                </div>

                <div class="text-end">
                    <div class="d-flex align-items-center gap-2">
                        <div class="rate-badge">@((Model.AvgRate ?? 0).ToString("0.0")) <small class="text-muted">/5</small></div>
                        <div class="stars" aria-hidden="true">
                            @for (int i = 1; i <= 5; i++)
                            {
                                var filledClass = (Model.AvgRate ?? 0) >= i ? "bi-star-fill filled" : "bi-star";
                                <i class="star @filledClass"></i>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <hr />

            <!-- Bình luận & rating -->
            <div class="comment-box">
                <h6>Bình luận & đánh giá</h6>
                <div id="commentFormArea" class="mt-2">
                    @if (User?.Identity?.IsAuthenticated == true)
                    {
                        @Html.AntiForgeryToken()
                        <div class="mb-2"><strong>Đánh giá của bạn:</strong></div>
                        <div class="mb-2">
                            <div id="userStars" class="stars">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <i class="star bi bi-star" data-value="@i"></i>
                                }
                            </div>
                        </div>
                        <div class="mb-2">
                            <textarea id="commentText" class="form-control" rows="3" placeholder="Viết bình luận của bạn..."></textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="submitComment" class="btn btn-primary">Gửi bình luận</button>
                            <small class="text-muted align-self-center">Bình luận sẽ xuất hiện sau khi được duyệt.</small>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info py-2">Bạn cần <a href="@Url.Action("Login","Account", new { area = "Client" })">đăng nhập</a> để bình luận.</div>
                    }
                </div>

                <hr />

                <div id="commentsList">
                    @if (Model.Comments != null && Model.Comments.Any())
                    {
                        foreach (var c in Model.Comments)
                        {
                            <div class="comment-item">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <span class="comment-user">@c.UserName</span>
                                        <span class="small text-muted">•</span>
                                        <span class="comment-time">@((c.CreatedAt.HasValue) ? c.CreatedAt.Value.ToString("dd MMM yyyy HH:mm") : "")</span>
                                    </div>
                                    <div class="stars" aria-hidden="true">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            var filledClass = c.Rate >= i ? "bi-star-fill filled" : "bi-star";
                                            <i class="star @filledClass"></i>
                                        }
                                    </div>
                                </div>
                                <div class="mt-1">@Html.Raw(System.Net.WebUtility.HtmlEncode(c.Text))</div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-muted">Chưa có bình luận nào — bạn có thể là người đầu tiên!</div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const stars = document.querySelectorAll('#userStars .star');
            let selected = 0;

            function setStarState(el, filled) {
                if (filled) {
                    el.classList.remove('bi-star');
                    el.classList.add('bi-star-fill','filled','active');
                } else {
                    el.classList.remove('bi-star-fill','filled','active');
                    el.classList.add('bi-star');
                }
            }

            function highlight(v) {
                stars.forEach(st => {
                    const val = +st.dataset.value;
                    setStarState(st, val <= v);
                });
            }

            stars.forEach(s => {
                s.addEventListener('mouseenter', () => highlight(+s.dataset.value));
                s.addEventListener('mouseleave', () => highlight(selected));
                s.addEventListener('click', () => { selected = +s.dataset.value; highlight(selected); });
                setStarState(s, false);
            });

            const submitBtn = document.getElementById('submitComment');
            if (submitBtn) {
                submitBtn.addEventListener('click', async function () {
                    const text = document.getElementById('commentText').value.trim();
                    if (selected <= 0) { alert('Vui lòng chọn số sao.'); return; }
                    if (!text) { alert('Vui lòng nhập nội dung bình luận.'); return; }

                    const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                    const token = tokenInput ? tokenInput.value : '';

                    submitBtn.disabled = true;
                    submitBtn.innerText = 'Đang gửi...';

                    try {
                        const resp = await fetch('@Url.Action("AddComment", "Stores", new { area = "Client" })', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'RequestVerificationToken': token,
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: new URLSearchParams({
                                tenantId: '@Model.TenantId',
                                rate: selected,
                                text: text
                            })
                        });

                        const data = await resp.json();
                        if (data && data.success) {
                            alert(data.message || 'Gửi thành công.');
                            document.getElementById('commentText').value = '';
                            selected = 0;
                            highlight(0);
                        } else {
                            alert(data?.message || 'Lỗi khi gửi bình luận.');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Có lỗi xảy ra. Vui lòng thử lại.');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerText = 'Gửi bình luận';
                    }
                });
            }
        })();
    </script>
}
