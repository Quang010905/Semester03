@model Semester03.Areas.Client.Models.ViewModels.RegisterViewModel
@{
    ViewData["Title"] = "Register";
    var returnUrl = ViewData["ReturnUrl"] as string;
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
    :root {
        --accent: #6f42c1;
        --accent-2: #7b61ff;
    }

    body {
        font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: linear-gradient(135deg, #0f172a 0%, #0b1220 40%, #07102a 100%);
        min-height: 100vh;
        color: #e6eef8;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 16px;
    }

    .auth-card {
        width: 100%;
        max-width: 520px;
        background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 10px 30px rgba(2,6,23,0.6);
        border: 1px solid rgba(255,255,255,0.03);
        backdrop-filter: blur(6px);
    }

    .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }

        .brand .logo {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(45deg,var(--accent),var(--accent-2));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(99,102,241,0.18);
        }

    .auth-title {
        font-size: 20px;
        font-weight: 700;
        color: #f8fafc;
    }

    .auth-sub {
        color: #cbd5e1;
        font-size: 13px;
    }

    label.form-label {
        color: #dbeafe;
        font-weight: 600;
    }

    .form-control {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.05);
        color: #e6eef8;
    }

        .form-control:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 0.15rem rgba(107,70,193,0.12);
        }

    .btn-primary {
        background: linear-gradient(90deg,var(--accent),var(--accent-2));
        border: none;
        box-shadow: 0 8px 20px rgba(107,70,193,0.15);
        font-weight: 600;
    }

    .small-muted {
        color: #9aa7c7;
        font-size: 13px;
    }

    .field-error {
        color: #ffb4b4;
        font-size: 13px;
        margin-top: 6px;
        display: block;
    }

    .global-error {
        background: rgba(255,80,80,0.08);
        color: #ffb4b4;
        padding: 8px 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        border: 1px solid rgba(255,80,80,0.06);
    }
</style>

<div class="auth-card">
    <div class="brand">
        <div class="logo">GM</div>
        <div>
            <div class="auth-title">GigaMall — Create account</div>
            <div class="auth-sub">Fast, secure and ready to use (no email verification in this demo)</div>
        </div>
    </div>

    <div id="globalAlert" class="mb-3" style="display:none;"></div>

    <form id="registerForm" method="post" novalidate>
        @Html.AntiForgeryToken()
        <input type="hidden" name="returnUrl" value="@returnUrl" />

        <div class="row g-3">
            <div class="col-12">
                <label class="form-label" for="Username">Username</label>
                <input asp-for="Username" id="Username" name="Username" class="form-control" minlength="3" maxlength="100" required />
                <div class="field-error" data-valmsg-for="Username"></div>
            </div>

            <div class="col-12">
                <label class="form-label" for="FullName">Full name</label>
                <input asp-for="FullName" id="FullName" name="FullName" class="form-control" required />
                <div class="field-error" data-valmsg-for="FullName"></div>
            </div>

            <div class="col-md-6">
                <label class="form-label" for="Email">Email</label>
                <input asp-for="Email" id="Email" name="Email" type="email" class="form-control" required />
                <div class="field-error" data-valmsg-for="Email"></div>
            </div>

            <div class="col-md-6">
                <label class="form-label" for="Phone">Phone</label>
                <input asp-for="Phone" id="Phone" name="Phone" class="form-control" required />
                <div class="field-error" data-valmsg-for="Phone"></div>
            </div>

            <div class="col-md-6">
                <label class="form-label" for="Password">Password</label>
                <input asp-for="Password" id="Password" name="Password" type="password" minlength="6" class="form-control" required />
                <div class="field-error" data-valmsg-for="Password"></div>
            </div>

            <div class="col-md-6">
                <label class="form-label" for="ConfirmPassword">Confirm password</label>
                <input asp-for="ConfirmPassword" id="ConfirmPassword" name="ConfirmPassword" type="password" minlength="6" class="form-control" required />
                <div class="field-error" data-valmsg-for="ConfirmPassword"></div>
            </div>

            <div class="col-12 d-flex justify-content-between align-items-center">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="showPass" />
                    <label class="form-check-label small-muted" for="showPass">Show password</label>
                </div>
                <div>
                    <a href="@Url.Action("Login", "Account", new { area = "Client" })" class="small-muted">Already have an account? Sign in</a>
                </div>
            </div>

            <div class="col-12">
                <button id="btnSubmit" type="submit" class="btn btn-primary w-100 py-2">Create account</button>
            </div>

            <div class="col-12 text-center small-muted">
                By creating an account you agree to our <a href="#" class="text-decoration-underline">Terms</a>.
            </div>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    (function () {
        const $ = (sel, base = document) => base.querySelector(sel);
        const $$ = (sel, base = document) => Array.from(base.querySelectorAll(sel));

        const form = document.getElementById('registerForm');
        const submitBtn = document.getElementById('btnSubmit');
        const globalAlert = document.getElementById('globalAlert');

        document.getElementById('showPass').addEventListener('change', function () {
            const pass = document.getElementById('Password');
            const cpass = document.getElementById('ConfirmPassword');
            if (this.checked) { pass.type = 'text'; cpass.type = 'text'; }
            else { pass.type = 'password'; cpass.type = 'password'; }
        });

        function clearErrors() {
            $$('.field-error').forEach(el => el.textContent = '');
            globalAlert.style.display = 'none';
            globalAlert.innerHTML = '';
        }

        function showGlobalError(html) {
            globalAlert.style.display = 'block';
            globalAlert.className = 'global-error';
            globalAlert.innerHTML = html;
        }

        function showErrors(errors) {
            clearErrors();
            for (const key in errors) {
                if (!Object.prototype.hasOwnProperty.call(errors, key)) continue;
                const msgs = errors[key];
                const fieldEl = document.querySelector(`[data-valmsg-for="${key}"]`);
                if (fieldEl) {
                    fieldEl.textContent = msgs.join(' · ');
                } else {
                    showGlobalError(msgs.join('<br/>'));
                }
            }
        }

        function getAntiForgeryToken() {
            const el = document.querySelector('input[name="__RequestVerificationToken"]');
            return el ? el.value : '';
        }

        function validateClient() {
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return false;
            }
            const p = document.getElementById('Password').value;
            const cp = document.getElementById('ConfirmPassword').value;
            if (p !== cp) {
                document.querySelector('[data-valmsg-for="ConfirmPassword"]').textContent = 'Password confirmation does not match';
                return false;
            }
            return true;
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            clearErrors();

            if (!validateClient()) return;

            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                const formData = new FormData(form);
                const token = getAntiForgeryToken();

                const resp = await fetch('@Url.Action("Register", "Account", new { area = "Client" })', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: formData
                });

                if (resp.ok) {
                    const data = await resp.json();
                    if (data.success) {
                        window.location.href = data.redirect || '/';
                        return;
                    } else {
                        showErrors(data.errors || { "": ["Unknown error occurred."] });
                    }
                } else {
                    let json;
                    try { json = await resp.json(); } catch (ex) { json = null; }

                    if (json && json.errors) {
                        showErrors(json.errors);
                    } else if (json && json.message) {
                        showGlobalError(json.message);
                    } else {
                        showGlobalError('Failed to submit request. Please try again later.');
                    }
                }
            } catch (ex) {
                console.error(ex);
                showGlobalError('Network or server error. Please try again later.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create account';
            }
        });
    })();
</script>
