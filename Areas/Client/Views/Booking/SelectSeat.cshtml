@model Semester03.Areas.Client.Models.ViewModels.SelectSeatVm
@{
    Layout = "~/Areas/Client/Views/Shared/_LayoutClient.cshtml";
}

@section Styles {
    <style>
        .screen-bar {
            background: linear-gradient(90deg,#343a40,#495057);
            color: #fff;
            text-align: center;
            padding: .6rem 1rem;
            border-radius: .5rem;
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        .legend {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin: .75rem 0;
        }

            .legend .box {
                width: 18px;
                height: 18px;
                border-radius: 4px;
                display: inline-block;
                margin-right: .4rem;
                border: 1px solid #ddd;
            }

        .seat-grid {
            display: grid;
            gap: .5rem;
            justify-items: center;
            padding: 1rem;
            background: #fff;
            border-radius: .5rem;
        }

        .seat-btn {
            min-width: 46px;
            min-height: 36px;
            border-radius: 6px;
            border: 1px solid #d0d5d9;
            cursor: pointer;
            transition: transform .08s ease, box-shadow .08s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

            .seat-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            }

        .seat-available {
            background: #f8f9fa;
            color: #222;
        }

        .seat-taken {
            background: #dc3545;
            color: #fff;
            cursor: not-allowed;
        }

        .seat-reserved {
            background: #d9534f;
            color: #fff;
            cursor: not-allowed;
        }
        /* reserved by others */
        .seat-selected {
            background: #198754;
            color: #fff;
        }
        /* selected by me */
        .row-label {
            font-weight: 700;
            margin-right: .5rem;
        }

        .controls {
            margin-top: 1rem;
            display: flex;
            gap: .75rem;
            align-items: center;
        }

        .screen-holder {
            padding: .8rem 1rem;
            margin-bottom: .6rem;
            border-radius: .5rem;
            background: linear-gradient(180deg,#eef3ff,#fff);
        }
    </style>
}

<div class="container py-4">
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">@Model.MovieTitle</h4>
                <div class="small text-muted">@Model.ScreenName • @Model.ShowtimeStart.ToString("dd MMM yyyy HH:mm")</div>
            </div>
            <div>
                <a class="btn btn-outline-secondary" href="javascript:history.back()">← Back</a>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="screen-holder">
                <div class="screen-bar">MÀN CHIẾU</div>
                <div class="mt-3 small text-muted">Màn chiếu được đặt phía trên. Chọn ghế (xám = trống, đỏ = đã đặt).</div>
            </div>

            <div class="card p-3">
                <div class="legend">
                    <div><span class="box" style="background:#f8f9fa;border:1px solid #d0d5d9"></span> Chưa đặt</div>
                    <div><span class="box" style="background:#dc3545"></span> Đã đặt</div>
                    <div><span class="box" style="background:#198754"></span> Bạn chọn</div>
                </div>

                <div id="seatArea">
                    @* grid will be rendered by JS using available data in data-seats attribute *@
                    <div id="seatGrid" class="seat-grid" style="grid-template-columns: repeat(@Model.MaxCols, minmax(46px,1fr));"></div>
                </div>

                <div class="controls">
                    <div class="me-auto small text-muted" id="selectionInfo">Chưa chọn ghế nào</div>
                    <button id="btnReserve" class="btn btn-primary" disabled>Đặt chỗ</button>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-3">
                <h6 class="mb-2">Thông tin</h6>
                <dl class="row small">
                    <dt class="col-5">Phim</dt>
                    <dd class="col-7">@Model.MovieTitle</dd>
                    <dt class="col-5">Rạp</dt>
                    <dd class="col-7">@Model.ScreenName</dd>
                    <dt class="col-5">Suất</dt>
                    <dd class="col-7">@Model.ShowtimeStart.ToString("dd MMM yyyy HH:mm")</dd>
                    <dt class="col-5">Tổng ghế</dt>
                    <dd class="col-7">@Model.Seats.Count</dd>
                </dl>
                <hr />
                <div>
                    <strong>Ghi chú</strong>
                    <p class="small text-muted">Những ghế màu xám là trống, bạn có thể chọn. Ghế màu đỏ đã được đặt/không thể chọn. Sau khi chọn nhấn "Đặt chỗ" để giữ ghế (sẽ đánh dấu là reserved).</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            // serialize Model to camelCase so JS keys like vm.seats, vm.showtimeId match
            const vm = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));

            const seatGrid = document.getElementById('seatGrid');
            const selectionInfo = document.getElementById('selectionInfo');
            const btnReserve = document.getElementById('btnReserve');

            if (!vm || !seatGrid) {
                console.error('No model or seatGrid element found', vm);
                return;
            }

            const seats = vm.seats || [];
            const maxCols = vm.maxCols || 10;

            // build position map
            const byPos = {};
            seats.forEach(s => {
                // ensure numeric col
                const col = Number(s.col || 0);
                const row = (s.row || '').toString();
                byPos[`${row}_${col}`] = s;
            });

            // compute row list in order (A,B,C,...)
            const rowSet = new Set(seats.map(s => (s.row || '').toString()).filter(x => x));
            const rowList = Array.from(rowSet).sort();

            seatGrid.style.gridTemplateColumns = `repeat(${maxCols}, minmax(46px,1fr))`;
            seatGrid.innerHTML = '';

            // render rows in order; if some rows empty it'll still create placeholders
            rowList.forEach(r => {
                for (let c = 1; c <= maxCols; c++) {
                    const key = `${r}_${c}`;
                    const s = byPos[key];
                    if (s) {
                        const btn = document.createElement('button');
                        btn.className = 'seat-btn';
                        btn.dataset.showtimeSeatId = s.showtimeSeatId;
                        btn.dataset.label = s.label;
                        btn.dataset.status = (s.status || 'available').toString();
                        btn.dataset.row = s.row || '';
                        btn.dataset.col = s.col || '';

                        btn.innerText = s.label;

                        const status = (btn.dataset.status || '').toString().trim().toLowerCase();
                        if (status === 'available') {
                            btn.classList.add('seat-available');
                            btn.addEventListener('click', onSeatClick);
                        } else {
                            // treat reserved/sold/blocked as taken
                            btn.classList.add('seat-taken');
                            btn.disabled = true;
                        }

                        seatGrid.appendChild(btn);
                    } else {
                        // placeholder to maintain grid layout
                        const ph = document.createElement('div');
                        ph.style.width = '46px';
                        ph.style.height = '36px';
                        ph.style.opacity = '0';
                        seatGrid.appendChild(ph);
                    }
                }
            });

            let selected = new Set();

            function onSeatClick(e) {
                const b = e.currentTarget;
                const id = b.dataset.showtimeSeatId;
                if (!id) return;

                const status = (b.dataset.status || '').trim().toLowerCase();
                if (status !== 'available') return; // double-check

                if (selected.has(id)) {
                    selected.delete(id);
                    b.classList.remove('seat-selected');
                    b.classList.add('seat-available');
                } else {
                    selected.add(id);
                    b.classList.remove('seat-available');
                    b.classList.add('seat-selected');
                }
                refreshSelectionUI();
            }

            function refreshSelectionUI() {
                const arr = Array.from(selected);
                if (arr.length === 0) {
                    selectionInfo.innerText = 'Chưa chọn ghế nào';
                    btnReserve.disabled = true;
                } else {
                    // get labels
                    const labels = arr.map(id => {
                        const el = seatGrid.querySelector('[data-showtime-seat-id="'+id+'"]');
                        return el ? el.dataset.label : id;
                    }).filter(Boolean);
                    selectionInfo.innerText = 'Ghế đã chọn: ' + labels.join(', ');
                    btnReserve.disabled = false;
                }
            }

            btnReserve.addEventListener('click', function(){
                if (selected.size === 0) return;
                const payload = {
                    showtimeId: vm.showtimeId,
                    showtimeSeatIds: Array.from(selected).map(x => parseInt(x))
                };

                btnReserve.disabled = true;
                btnReserve.innerText = 'Đang xử lý...';

                fetch('@Url.Action("ReserveSeats", "Booking", new { area = "Client" })', {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json','Accept':'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(r => r.json())
                .then(data => {
                    if (!data) throw new Error('No response');
                    if (data.success) {
                        // simplest: reload to reflect reserved seats
                        location.reload();
                    } else {
                        alert('Một số ghế không thể đặt: ' + (data.failed || []).join(', '));
                        location.reload();
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Lỗi khi đặt ghế.');
                })
                .finally(()=> {
                    btnReserve.disabled = false;
                    btnReserve.innerText = 'Đặt chỗ';
                });
            });

        })();
    </script>
}
