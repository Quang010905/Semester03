@model Semester03.Areas.Client.Models.ViewModels.SelectSeatVm
@{
    Layout = "~/Areas/Client/Views/Shared/_LayoutClient.cshtml";
}

@section Styles {
    <style>
        .screen-bar {
            background: linear-gradient(90deg,#343a40,#495057);
            color: #fff;
            text-align: center;
            padding: .6rem 1rem;
            border-radius: .5rem;
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        .legend {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin: .75rem 0;
        }

            .legend .box {
                width: 18px;
                height: 18px;
                border-radius: 4px;
                display: inline-block;
                margin-right: .4rem;
                border: 1px solid #ddd;
            }

        .seat-grid {
            display: grid;
            gap: .5rem;
            justify-items: center;
            padding: 1rem;
            background: #fff;
            border-radius: .5rem;
        }

        .seat-btn {
            min-width: 46px;
            min-height: 36px;
            border-radius: 6px;
            border: 1px solid #d0d5d9;
            cursor: pointer;
            transition: transform .08s ease, box-shadow .08s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

            .seat-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            }

        .seat-available {
            background: #f8f9fa;
            color: #222;
        }

        .seat-taken {
            background: #dc3545;
            color: #fff;
            cursor: not-allowed;
        }

        .seat-reserved {
            background: #d9534f;
            color: #fff;
            cursor: not-allowed;
        }

        .seat-selected {
            background: #198754;
            color: #fff;
        }

        .row-label {
            font-weight: 700;
            margin-right: .5rem;
        }

        .controls {
            margin-top: 1rem;
            display: flex;
            gap: .75rem;
            align-items: center;
        }

        .screen-holder {
            padding: .8rem 1rem;
            margin-bottom: .6rem;
            border-radius: .5rem;
            background: linear-gradient(180deg,#eef3ff,#fff);
        }
    </style>
}

<div class="container py-4">
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">@Model.MovieTitle</h4>
                <div class="small text-muted">@Model.ScreenName • @Model.ShowtimeStart.ToString("dd MMM yyyy HH:mm")</div>
            </div>
            <div>
                <a class="btn btn-outline-secondary" href="javascript:history.back()">← Back</a>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="screen-holder">
                <div class="screen-bar">MÀN CHIẾU</div>
                <div class="mt-3 small text-muted">Màn chiếu được đặt phía trên. Chọn ghế (xám = trống, đỏ = đã đặt).</div>
            </div>

            <div class="card p-3">
                <div class="legend">
                    <div><span class="box" style="background:#f8f9fa;border:1px solid #d0d5d9"></span> Chưa đặt</div>
                    <div><span class="box" style="background:#dc3545"></span> Đã đặt</div>
                    <div><span class="box" style="background:#198754"></span> Bạn chọn</div>
                </div>

                <div id="seatArea">
                    <div id="seatGrid" class="seat-grid" style="grid-template-columns: repeat(@Model.MaxCols, minmax(46px,1fr));"></div>
                </div>

                <!-- giữ form (nếu cần) nhưng nút là button type=button để tránh submit mặc định -->
                <form id="seatForm" method="post" action="@Url.Action("ConfirmBooking","Booking", new { area = "Client" })">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="showtimeId" value="@Model.ShowtimeId" />
                    <input type="hidden" id="seatIds" name="seatIds" />
                    <div class="controls">
                        <div class="me-auto small text-muted" id="selectionInfo">Chưa chọn ghế nào</div>
                        <button id="btnReserve" type="button" class="btn btn-primary" disabled>Đặt chỗ</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-3">
                <h6 class="mb-2">Thông tin</h6>
                <dl class="row small">
                    <dt class="col-5">Phim</dt>
                    <dd class="col-7">@Model.MovieTitle</dd>
                    <dt class="col-5">Rạp</dt>
                    <dd class="col-7">@Model.ScreenName</dd>
                    <dt class="col-5">Suất</dt>
                    <dd class="col-7">@Model.ShowtimeStart.ToString("dd MMM yyyy HH:mm")</dd>
                    <dt class="col-5">Tổng ghế</dt>
                    <dd class="col-7">@Model.Seats.Count</dd>
                </dl>
                <hr />
                <div>
                    <strong>Ghi chú</strong>
                    <p class="small text-muted">Ghế xám là trống, ghế đỏ là đã đặt, ghế xanh là bạn chọn. Nhấn "Đặt chỗ" để xác nhận.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            // serializing model to camelCase JSON for client
            const vm = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
            const seatGrid = document.getElementById('seatGrid');
            const selectionInfo = document.getElementById('selectionInfo');
            const btnReserve = document.getElementById('btnReserve');

            if (!vm || !seatGrid) {
                console.error('No model or seatGrid element found', vm);
                return;
            }

            const seats = vm.seats || [];
            const maxCols = vm.maxCols || 10;

            // map by row_col for quick lookup
            const byPos = {};
            seats.forEach(s => {
                const col = Number(s.col || 0);
                const row = (s.row || '').toString();
                byPos[`${row}_${col}`] = s;
            });

            // build ordered row list (alphanumeric sort)
            const rowSet = new Set(seats.map(s => (s.row || '').toString()).filter(x => x));
            const rowList = Array.from(rowSet).sort((a,b) => {
                // nếu row là ký tự như "A","B" thì sắp xếp lexicographically; nếu numeric, compare numeric
                const na = Number(a), nb = Number(b);
                if (!isNaN(na) && !isNaN(nb)) return na - nb;
                return a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'});
            });

            seatGrid.style.gridTemplateColumns = `repeat(${maxCols}, minmax(46px,1fr))`;
            seatGrid.innerHTML = '';

            rowList.forEach(r => {
                for (let c = 1; c <= maxCols; c++) {
                    const key = `${r}_${c}`;
                    const s = byPos[key];
                    if (s) {
                        const btn = document.createElement('button');
                        btn.className = 'seat-btn';
                        btn.type = 'button';
                        // data attributes use kebab-case when rendered in DOM but accessing via dataset will camelCase
                        btn.dataset.showtimeSeatId = s.showtimeSeatId;
                        btn.dataset.label = s.label;
                        btn.dataset.status = (s.status || 'available').toString();
                        btn.dataset.row = s.row || '';
                        btn.dataset.col = s.col || '';
                        btn.innerText = s.label;

                        const status = (btn.dataset.status || '').toString().trim().toLowerCase();
                        if (status === 'available' || status === '' || status === 'free') {
                            btn.classList.add('seat-available');
                            btn.addEventListener('click', onSeatClick);
                        } else if (status === 'reserved') {
                            btn.classList.add('seat-reserved');
                            btn.disabled = true;
                        } else {
                            btn.classList.add('seat-taken');
                            btn.disabled = true;
                        }

                        seatGrid.appendChild(btn);
                    } else {
                        // placeholder để giữ lưới cân đối
                        const ph = document.createElement('div');
                        ph.style.width = '46px';
                        ph.style.height = '36px';
                        ph.style.opacity = '0';
                        seatGrid.appendChild(ph);
                    }
                }
            });

            let selected = new Set();

            function onSeatClick(e) {
                const b = e.currentTarget;
                const id = b.dataset.showtimeSeatId;
                if (!id) return;

                const status = (b.dataset.status || '').trim().toLowerCase();
                if (status !== 'available' && status !== '') return;

                if (selected.has(id)) {
                    selected.delete(id);
                    b.classList.remove('seat-selected');
                    b.classList.add('seat-available');
                } else {
                    selected.add(id);
                    b.classList.remove('seat-available');
                    b.classList.add('seat-selected');
                }
                refreshSelectionUI();
            }

            function refreshSelectionUI() {
                const arr = Array.from(selected);
                // cập nhật ẩn dành cho form (nếu bạn muốn submit truyền thẳng)
                document.getElementById('seatIds').value = arr.join(',');

                if (arr.length === 0) {
                    selectionInfo.innerText = 'Chưa chọn ghế nào';
                    btnReserve.disabled = true;
                } else {
                    const labels = arr.map(id => {
                        const el = seatGrid.querySelector('[data-showtime-seat-id="'+id+'"]');
                        return el ? el.dataset.label : id;
                    }).filter(Boolean);
                    selectionInfo.innerText = 'Ghế đã chọn: ' + labels.join(', ');
                    btnReserve.disabled = false;
                }
            }

            // thêm log debug để nhanh thấy response
            btnReserve.addEventListener('click', function(){
                if (selected.size === 0) {
                    alert('Vui lòng chọn ít nhất 1 ghế trước khi đặt.');
                    return;
                }

                btnReserve.disabled = true;
                const previousText = btnReserve.innerText;
                btnReserve.innerText = 'Đang đặt...';

                const payload = {
                    showtimeId: vm.showtimeId,
                    showtimeSeatIds: Array.from(selected).map(x => parseInt(x, 10))
                };

                console.log('Reserve payload:', payload);

                fetch('@Url.Action("ReserveSeats", "Booking", new { area = "Client" })', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(async res => {
                    console.log('raw response status', res.status);
                    if (!res.ok) {
                        const txt = await res.text();
                        throw new Error('Server error: ' + txt);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('reserve result', data);
                    if (!data) throw new Error('Empty response from server');

                    // Nếu có ít nhất 1 ghế thành công -> redirect đến ConfirmBooking với danh sách succeeded ids
                    if (data.success && data.succeeded && data.succeeded.length > 0) {
                        const target = '@Url.Action("ConfirmBooking", "Booking", new { area = "Client" })';
                        const qs = '?showtimeId=' + encodeURIComponent(vm.showtimeId) + '&seatIds=' + encodeURIComponent(data.succeeded.join(','));
                        // redirect
                        window.location.href = target + qs;
                        return;
                    } else {
                        // Không thành công: hiển thị thông báo về failed labels (nếu có), reload để lấy layout mới
                        const failedLabels = (data.failedLabels && data.failedLabels.length) ? data.failedLabels : data.failed;
                        alert('Không thể đặt những ghế sau: ' + (failedLabels && failedLabels.length ? failedLabels.join(', ') : 'Không xác định'));
                        // nếu server trả layout mới, có thể render lại — hiện tại reload cho nhanh
                        location.reload();
                    }
                })
                .catch(err => {
                    console.error('Lỗi khi đặt ghế:', err);
                    alert('Lỗi khi đặt ghế: ' + (err.message || err));
                })
                .finally(() => {
                    btnReserve.disabled = false;
                    btnReserve.innerText = previousText || 'Đặt chỗ';
                });
            });

        })();
    </script>
}
