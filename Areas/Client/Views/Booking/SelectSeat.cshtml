@model Semester03.Areas.Client.Models.ViewModels.SelectSeatVm
@{
    Layout = "~/Areas/Client/Views/Shared/_LayoutClient.cshtml";
    ViewData["Title"] = "Select seats";
}

@section Styles {
    <style>
        .cinema-shell {
            max-width: 1100px;
            margin: 0 auto;
        }

        .screen-holder {
            padding: .9rem 1rem;
            margin-bottom: 1rem;
            border-radius: 18px;
            background: radial-gradient(circle at top, #e0ebff 0, #ffffff 55%, #eef2ff 100%);
            box-shadow: 0 14px 40px rgba(15,23,42,0.16);
        }

        .screen-bar {
            background: linear-gradient(90deg, #0d6efd, #6f42c1);
            color: #fff;
            text-align: center;
            padding: .7rem 1rem;
            border-radius: 999px;
            font-weight: 700;
            letter-spacing: 0.16em;
            font-size: .8rem;
            box-shadow: 0 14px 30px rgba(37,99,235,0.55);
            text-transform: uppercase;
        }

        .screen-subtext {
            margin-top: .75rem;
            font-size: .85rem;
            color: #6b7280;
            text-align: center;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin: .75rem 0 1rem;
            font-size: .85rem;
        }

            .legend .box {
                width: 18px;
                height: 18px;
                border-radius: 6px;
                display: inline-block;
                margin-right: .4rem;
                border: 1px solid #d0d5d9;
            }

        .seat-card {
            border-radius: 16px;
            border: none;
            box-shadow: 0 14px 40px rgba(15,23,42,0.12);
            overflow: hidden;
        }

        .seat-grid-wrapper {
            background: #f3f4f6;
            border-radius: 1rem;
            padding: 1.3rem 1.3rem 1rem;
            box-shadow: inset 0 0 0 1px rgba(148,163,184,0.15);
        }

        .seat-grid {
            display: grid;
            gap: .5rem;
            justify-items: center;
        }

        .seat-btn {
            min-width: 46px;
            min-height: 36px;
            border-radius: 9px;
            border: 1px solid #d1d5db;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: .85rem;
            background: #ffffff;
            color: #111827;
            transition: transform .09s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
        }

            .seat-btn:hover:not(.seat-taken):not(.seat-reserved):not(.seat-selected):not(.seat-maint) {
                transform: translateY(-2px);
                box-shadow: 0 10px 24px rgba(15,23,42,0.18);
                border-color: #0d6efd;
                background: #eff6ff;
            }

        .seat-available {
            background: #f9fafb;
            color: #111827;
        }

        .seat-taken {
            background: #ef4444;
            color: #fff;
            cursor: not-allowed;
            box-shadow: 0 8px 24px rgba(220,38,38,0.7);
            border-color: #b91c1c;
        }

        .seat-reserved {
            background: #fed7aa;
            color: #7c2d12;
            cursor: not-allowed;
            border-color: #fb923c;
        }

        .seat-maint {
            /* ghế đang sửa / hư — màu vàng */
            background: linear-gradient(135deg,#fef3c7,#fde68a);
            color: #7c2d12;
            cursor: not-allowed;
            border-color: #fbbf24;
            box-shadow: 0 6px 18px rgba(245,158,11,0.18);
        }

        .seat-selected {
            background: linear-gradient(135deg,#22c55e,#16a34a);
            color: #fff;
            border-color: #15803d;
            box-shadow: 0 10px 30px rgba(22,163,74,0.75);
        }

        .controls {
            margin-top: 1.1rem;
            display: flex;
            gap: .75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        #selectionInfo {
            font-size: .9rem;
        }

        .booking-summary-card {
            border-radius: 16px;
            border: none;
            box-shadow: 0 14px 40px rgba(15,23,42,0.14);
        }

        .summary-header {
            background: linear-gradient(135deg,#0f172a,#111827);
            color: #e5e7eb;
            border-radius: 12px;
            padding: .85rem 1rem;
            margin-bottom: 1rem;
        }

            .summary-header .title {
                font-size: .95rem;
                font-weight: 600;
            }

        .summary-label {
            color: #9ca3af;
        }
    </style>
}

<div class="container py-4 cinema-shell">
    <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <h4 class="mb-0">@Model.MovieTitle</h4>
            <div class="small text-muted">
                @Model.ScreenName • @Model.ShowtimeStart.ToString("dd MMM yyyy HH:mm")
            </div>
        </div>
        <div>
            <a class="btn btn-outline-secondary btn-sm" href="javascript:history.back()">← Back</a>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="screen-holder">
                <div class="screen-bar">SCREEN</div>
                <div class="screen-subtext">
                    The screen is at the top. Choose your seats (grey = available, red = booked, green = your selection, yellow = under maintenance).
                </div>
            </div>

            <div class="card p-3 seat-card">
                <div class="legend">
                    <div>
                        <span class="box" style="background:#f9fafb;border:1px solid #d1d5db"></span>
                        Available
                    </div>
                    <div>
                        <span class="box" style="background:#ef4444;border-color:#b91c1c"></span>
                        Booked
                    </div>
                    <div>
                        <span class="box" style="background:linear-gradient(135deg,#22c55e,#16a34a);border-color:#15803d"></span>
                        Your selection
                    </div>
                    <div>
                        <span class="box" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#fbbf24"></span>
                        Under maintenance
                    </div>
                </div>

                <div id="seatArea" class="seat-grid-wrapper">
                    <div id="seatGrid"
                         class="seat-grid"
                         style="grid-template-columns: repeat(@Model.MaxCols, minmax(46px,1fr));">
                    </div>
                </div>

                <form id="seatForm" method="post"
                      action="@Url.Action("ConfirmBooking","Booking", new { area = "Client" })">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="showtimeId" value="@Model.ShowtimeId" />
                    <input type="hidden" id="seatIds" name="seatIds" />

                    <div class="controls mt-3">
                        <div class="me-auto small text-muted" id="selectionInfo">
                            No seats selected yet
                        </div>
                        <button id="btnReserve" type="button" class="btn btn-primary" disabled>
                            Reserve seats
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-3 booking-summary-card">
                <div class="summary-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="title">Booking summary</span>
                        <span class="small text-success">
                            <i class="bi bi-check2-circle me-1"></i>Step 1/2
                        </span>
                    </div>
                </div>
                <dl class="row small mb-0">
                    <dt class="col-5 summary-label">Movie</dt>
                    <dd class="col-7">@Model.MovieTitle</dd>

                    <dt class="col-5 summary-label">Screen</dt>
                    <dd class="col-7">@Model.ScreenName</dd>

                    <dt class="col-5 summary-label">Showtime</dt>
                    <dd class="col-7">@Model.ShowtimeStart.ToString("dd MMM yyyy HH:mm")</dd>

                    <dt class="col-5 summary-label">Total seats</dt>
                    <dd class="col-7">@Model.Seats.Count</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const vm = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
      Model,
      new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }
    ));

            const seatGrid = document.getElementById('seatGrid');
            const selectionInfo = document.getElementById('selectionInfo');
            const btnReserve = document.getElementById('btnReserve');

            if (!vm || !seatGrid) {
                console.error('No model or seatGrid element found', vm);
                return;
            }

            const seats = vm.seats || [];
            const maxCols = vm.maxCols || 10;

            const byPos = {};
            seats.forEach(s => {
                const col = Number(s.col || 0);
                const row = (s.row || '').toString();
                byPos[`${row}_${col}`] = s;
            });

            const rowSet = new Set(seats.map(s => (s.row || '').toString()).filter(x => x));
            const rowList = Array.from(rowSet).sort((a, b) => {
                const na = Number(a), nb = Number(b);
                if (!isNaN(na) && !isNaN(nb)) return na - nb;
                return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
            });

            seatGrid.style.gridTemplateColumns = `repeat(${maxCols}, minmax(46px,1fr))`;
            seatGrid.innerHTML = '';

            rowList.forEach(r => {
                for (let c = 1; c <= maxCols; c++) {
                    const key = `${r}_${c}`;
                    const s = byPos[key];

                    if (s) {
                        const btn = document.createElement('button');
                        btn.className = 'seat-btn';
                        btn.type = 'button';
                        btn.dataset.showtimeSeatId = s.showtimeSeatId;
                        btn.dataset.label = s.label;
                        btn.dataset.status = (s.status || 'available').toString();
                        btn.dataset.row = s.row || '';
                        btn.dataset.col = s.col || '';
                        // isActive from server (boolean). If undefined, assume true.
                        btn.dataset.isactive = (typeof s.isActive === 'undefined') ? 'true' : (s.isActive ? 'true' : 'false');
                        btn.innerText = s.label;

                        const status = (btn.dataset.status || '').toString().trim().toLowerCase();
                        const isActive = btn.dataset.isactive === 'true';

                        if (!isActive) {
                            // Seat under maintenance / hư -> yellow, disabled
                            btn.classList.add('seat-maint');
                            btn.disabled = true;

                        } else if (status === 'blocked' || status === 'locked') {
                            btn.classList.add('seat-maint'); // Dùng chung class màu vàng hoặc tạo class mới .seat-blocked
                            btn.title = "Seat blocked (Not available)";
                            btn.disabled = true;
                        } else if (status === 'available' || status === '' || status === 'free') {
                            btn.classList.add('seat-available');
                            btn.addEventListener('click', onSeatClick);
                        } else if (status === 'reserved') {
                            btn.classList.add('seat-reserved');
                            btn.disabled = true;
                        } else {
                            btn.classList.add('seat-taken');
                            btn.disabled = true;
                        }

                        seatGrid.appendChild(btn);
                    } else {
                        const ph = document.createElement('div');
                        ph.style.width = '46px';
                        ph.style.height = '36px';
                        ph.style.opacity = '0';
                        seatGrid.appendChild(ph);
                    }
                }
            });

            let selected = new Set();

            function onSeatClick(e) {
                const b = e.currentTarget;
                const id = b.dataset.showtimeSeatId;
                if (!id) return;

                const status = (b.dataset.status || '').trim().toLowerCase();
                // Double-check not selecting unavailable statuses or maintenance just in case
                const isActive = b.dataset.isactive === 'true';
                if (!isActive) return;
                if (status !== 'available' && status !== '') return;

                if (selected.has(id)) {
                    selected.delete(id);
                    b.classList.remove('seat-selected');
                    b.classList.add('seat-available');
                } else {
                    selected.add(id);
                    b.classList.remove('seat-available');
                    b.classList.add('seat-selected');
                }
                refreshSelectionUI();
            }

            function refreshSelectionUI() {
                const arr = Array.from(selected);
                document.getElementById('seatIds').value = arr.join(',');

                if (arr.length === 0) {
                    selectionInfo.innerText = 'No seats selected yet';
                    btnReserve.disabled = true;
                } else {
                    const labels = arr
                        .map(id => {
                            const el = seatGrid.querySelector('[data-showtime-seat-id="' + id + '"]');
                            return el ? el.dataset.label : id;
                        })
                        .filter(Boolean);

                    selectionInfo.innerText = 'Selected seats: ' + labels.join(', ');
                    btnReserve.disabled = false;
                }
            }

            btnReserve.addEventListener('click', function () {
                if (selected.size === 0) {
                    alert('Please select at least one seat.');
                    return;
                }

                btnReserve.disabled = true;
                const prev = btnReserve.innerText;
                btnReserve.innerText = 'Reserving...';

                const payload = {
                    showtimeId: vm.showtimeId,
                    showtimeSeatIds: Array.from(selected).map(x => parseInt(x, 10))
                };

                fetch('@Url.Action("ReserveSeats", "Booking", new { area = "Client" })', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                    .then(async res => {
                        if (!res.ok) {
                            const t = await res.text();
                            throw new Error(t || ('HTTP ' + res.status));
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data && data.success && data.succeeded && data.succeeded.length > 0) {
                            const target = '@Url.Action("ConfirmBooking", "Booking", new { area = "Client" })';
                            const qs = '?showtimeId=' + encodeURIComponent(vm.showtimeId) +
                                '&seatIds=' + encodeURIComponent(data.succeeded.join(','));
                            window.location.href = target + qs;
                        } else {
                            const failedLabels = (data && data.failedLabels && data.failedLabels.length)
                                ? data.failedLabels
                                : (data && data.failed) || [];

                            alert(
                                'Could not reserve: ' +
                                (failedLabels && failedLabels.length ? failedLabels.join(', ') : 'Unknown error')
                            );
                            location.reload();
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Error while reserving seats: ' + (err.message || err));
                    })
                    .finally(() => {
                        btnReserve.disabled = false;
                        btnReserve.innerText = prev;
                    });
            });
        })();
    </script>
}
