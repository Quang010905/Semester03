@model Semester03.Areas.Client.Models.ViewModels.BookTicketVm

@{
    Layout = "~/Areas/Client/Views/Shared/_LayoutClient.cshtml";
    ViewData["Title"] = "Book tickets";

    // Lấy đường dẫn poster từ model, có thể null/rỗng
    var rawPoster = (Model.Movie?.PosterUrl ?? string.Empty).Trim();

    // Tự tách tên file từ đường dẫn (không dùng System.IO.Path)
    string fileName = string.Empty;
    if (!string.IsNullOrEmpty(rawPoster))
    {
        var lastSlash = rawPoster.LastIndexOf('/');
        var lastBackslash = rawPoster.LastIndexOf('\\');
        var idx = Math.Max(lastSlash, lastBackslash);

        fileName = (idx >= 0 && idx < rawPoster.Length - 1)
            ? rawPoster.Substring(idx + 1)
            : rawPoster;
    }

    // Nếu không có tên file -> dùng ảnh mặc định
    var posterUrl = string.IsNullOrEmpty(fileName)
        ? Url.Content("~/Content/Uploads/noimage.png")
        : Url.Content("~/Content/Uploads/Movies/" + fileName);
}

@section Styles {
    <style>
        .movie-shell {
            max-width: 1100px;
            margin: 0 auto;
        }

        .movie-head {
            display: flex;
            gap: 1.1rem;
            align-items: flex-start;
        }

            .movie-head img {
                width: 96px;
                height: 140px;
                object-fit: cover;
                border-radius: .75rem;
                box-shadow: 0 16px 32px rgba(15,23,42,0.55);
            }

        .week-days {
            display: flex;
            gap: .6rem;
            overflow-x: auto;
            padding-bottom: .5rem;
        }

        .day-card {
            min-width: 110px;
            text-align: center;
            padding: .55rem .6rem;
            border-radius: .9rem;
            cursor: pointer;
            border: 1px solid transparent;
            background: #f3f4f6;
            font-size: .85rem;
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, border-color 0.12s ease;
        }

            .day-card .fw-semibold {
                font-size: .9rem;
            }

            .day-card.selected {
                background: linear-gradient(135deg, #0d6efd, #6366f1);
                color: #fff;
                border-color: transparent;
                box-shadow: 0 10px 28px rgba(37,99,235,0.4);
            }

        .showtime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: .75rem;
            margin-top: 1rem;
        }

        .showtime-slot {
            padding: .7rem .6rem .75rem;
            border-radius: .9rem;
            border: 1px solid #e5e7eb;
            text-align: center;
            background: #ffffff;
            transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
        }

            .showtime-slot:hover {
                box-shadow: 0 12px 30px rgba(15,23,42,0.16);
                transform: translateY(-3px);
                border-color: #0d6efd;
            }

        @@media (max-width: 576px) {
            .movie-head {
                flex-direction: row;
            }
        }
    </style>
}

<div class="container py-4 movie-shell">
    <div class="mb-3 movie-head">
        <img src="@posterUrl"
             alt="@Model.Movie?.Title"
             class="rounded shadow-sm" />
        <div>
            <h3 class="mb-1">@Model.Movie?.Title</h3>
            <div class="text-muted">
                Duration:
                @if (Model.Movie?.DurationMin != null)
                {
                    @Model.Movie.DurationMin
                }
                else
                {
                    @("--")
                }
            </div>
            <div class="mt-2 small">
                @Model.Movie?.Description
            </div>
        </div>
    </div>

    <div class="card p-3 mb-3">
        <div class="week-days" id="weekDays">
            @foreach (var d in Model.WeekDays)
            {
                var sel = d.Date.Date == Model.SelectedDate.Date ? "selected" : "";
                <div class="day-card @sel" data-date="@d.Date.ToString("yyyy-MM-dd")">
                    <div class="fw-semibold">@d.Date.ToString("ddd")</div>
                    <div>@d.Date.ToString("dd MMM")</div>
                </div>
            }
        </div>
    </div>

    <div id="showtimeContainer">
        <div id="loadingInitial" class="text-center py-5">Loading showtimes…</div>
        <div id="showtimeContent"></div>

        <script>
            (function () {
                const movieId = @Model.Movie?.Id ?? 0;
                const container = document.getElementById('showtimeContent');
                const loading = document.getElementById('loadingInitial');

                function loadFor(date) {
                    loading.style.display = '';
                    container.innerHTML = '';
                    fetch('@Url.Action("GetShowtimes", "Booking", new { area = "Client" })' + '?movieId=' + movieId + '&date=' + date)
                        .then(r => {
                            if (!r.ok) throw new Error('Failed to load showtimes.');
                            return r.text();
                        })
                        .then(html => container.innerHTML = html)
                        .catch(err => {
                            container.innerHTML = '<div class="text-danger p-3">Unable to load showtimes.</div>';
                            console.error(err);
                        })
                        .finally(() => loading.style.display = 'none');
                }

                const selDay = document.querySelector('.day-card.selected');
                if (selDay) {
                    loadFor(selDay.getAttribute('data-date'));
                }

                document.getElementById('weekDays').addEventListener('click', function (e) {
                    const card = e.target.closest('.day-card');
                    if (!card) return;
                    document.querySelectorAll('.day-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    loadFor(card.getAttribute('data-date'));
                });
            })();
        </script>
    </div>
</div>
