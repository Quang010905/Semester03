@model Semester03.Areas.Client.Models.ViewModels.CinemaHomeVm
@{
    Layout = "~/Areas/Client/Views/Shared/_LayoutClient.cshtml";

    // helper để chuẩn hóa đường dẫn ảnh (loại bỏ 'wwwroot/' nếu có, encode khoảng trắng)
    Func<string, string> Img = (raw) =>
    {
        if (string.IsNullOrWhiteSpace(raw))
        {
            return Url.Content("~/images/movie-placeholder.png");
        }

        // Nếu người lưu trong DB có chứa 'wwwroot/' hoặc bắt đầu bằng '/', loại bỏ
        var s = raw.Replace("wwwroot/", "").TrimStart('~', '/');

        // Encode spaces and ensure parentheses are kept (spaces -> %20)
        s = s.Replace(" ", "%20");

        // Nếu đường dẫn đã chứa "Admin/img" hay "images/..." thì Url.Content sẽ tìm từ webroot (~)
        return Url.Content("~/" + s);
    };
}

@section Styles {
    <style>
        /* ensure layout sidebar is sticky and above content visually but not overlapping content */
        .content-maxwide aside {
            position: sticky;
            top: 110px; /* adjust if header taller */
            z-index: 20;
        }

        /* movie grid hover / overlay */
        .movie-card {
            transition: transform .25s ease, box-shadow .25s ease;
            cursor: pointer;
            z-index: 1;
            background: #fff;
            position: relative;
        }

            .movie-card:hover {
                transform: translateY(-6px) scale(1.02);
                box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            }

        .movie-poster {
            height: 260px;
            object-fit: cover;
            width: 100%;
            border-radius: .25rem;
            display: block;
        }

        .movie-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 1rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.45));
            color: #fff;
            opacity: 0;
            transition: opacity .18s ease;
            border-radius: .25rem;
            /* IMPORTANT: overlay shows but doesn't block clicks by default */
            pointer-events: none;
        }

        /* show visual hover (opacity) but keep pointer-events none so clicks pass through to underlying link */
        .movie-card:hover .movie-overlay {
            opacity: 1;
            /* keep pointer-events: none; so the overlay won't intercept clicks */
            pointer-events: none;
        }

        /* Make sure overlay buttons (if any) remain clickable */
        .movie-overlay .btn {
            pointer-events: auto;
            position: relative;
            z-index: 5;
        }

        .movie-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .carousel-poster {
            height: 420px;
            object-fit: cover;
            width: 100%;
        }

        /* horizontal auto slider wrapper */
        .slider-wrapper {
            overflow: hidden;
            position: relative;
        }

        .slider-track {
            display: flex;
            gap: 1rem;
            transition: transform .6s ease;
            will-change: transform;
            align-items: stretch;
        }

        .slider-item {
            min-width: 220px;
            flex: 0 0 220px;
        }

        @@media (max-width:767px) {
            .movie-poster {
                height: 200px;
            }

            .carousel-poster {
                height: 240px;
            }

            .slider-item {
                min-width: 160px;
                flex: 0 0 160px;
            }
        }

        /* clamp description lines */
        .card .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
    </style>
}

<div class="py-2">
    <!-- Featured carousel -->
    @if (Model?.Featured?.Any() == true)
    {
        <div id="featuredCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
            <div class="carousel-inner">
                @for (int i = 0; i < Model.Featured.Count; i++)
                {
                    var f = Model.Featured[i];
                    var active = i == 0 ? "active" : "";
                    <div class="carousel-item @active">
                        <div class="row align-items-center">
                            <div class="col-lg-7">
                                <a href="@Url.Action("Details", "Cinema", new { area = "Client", id = f.Id })" class="d-block">
                                    <img src="@Img(f.PosterUrl)" class="d-block w-100 carousel-poster rounded" alt="@f.Title" />
                                </a>
                            </div>
                            <div class="col-lg-5">
                                <h2>@f.Title</h2>
                                <p class="text-muted">@f.Description</p>
                                <p>
                                    <strong>Next:</strong>
                                    @if (f.NextShowtime.HasValue)
                                    {
                                        <span>@f.NextShowtime.Value.ToString("dd MMM yyyy HH:mm")</span>
                                        <span class="ms-2 text-muted">(@(f.NextPrice.HasValue ? String.Format("{0:N0}", f.NextPrice.Value) : "—") VND)</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No upcoming showtime</span>
                                    }
                                </p>
                                <div class="mt-3">
                                    <a class="btn btn-primary"
                                       href="@Url.Action("BookTicket", "Booking", new { area = "Client", movieId = f.Id })">
                                        Book ticket
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#featuredCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#featuredCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>
    }

    <!-- Search bar -->
    <div class="mb-4">
        <form class="d-flex" onsubmit="event.preventDefault();">
            <input id="movieSearch" class="form-control me-2" placeholder="Search movies..." />
            <button class="btn btn-outline-secondary" onclick="filterMovies()">Search</button>
        </form>
    </div>

    <!-- Now showing area -->
    <h4 class="mb-3">Now showing</h4>

    <div class="slider-wrapper mb-3">
        <div id="sliderTrack" class="slider-track">
            @foreach (var m in Model?.NowShowing ?? Enumerable.Empty<Semester03.Areas.Client.Models.ViewModels.MovieCardVm>())
            {
                <div class="slider-item">
                    <div class="card movie-card position-relative h-100">
                        <a href="@Url.Action("Details", "Cinema", new { area = "Client", id = m.Id })" class="d-block">
                            <img src="@Img(m.PosterUrl)" class="movie-poster card-img-top" alt="@m.Title" />
                        </a>
                        <div class="movie-overlay">
                            <div class="w-100 text-center">
                                <div class="movie-title">@m.Title</div>
                                <div class="small">@((m.DurationMin.HasValue ? m.DurationMin.Value.ToString() : "--") + " min")</div>
                                <div class="mt-2">
                                    <a class="btn btn-sm btn-primary ms-1" href="@Url.Action("BookTicket", "Booking", new { area = "Client", movieId = m.Id })">Book</a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            <div class="small text-muted">@((m.NextShowtime.HasValue) ? m.NextShowtime.Value.ToString("dd MMM HH:mm") : "--")</div>
                            <div class="fw-semibold">@m.Title</div>
                            <p class="small text-truncate" title="@m.Description">@m.Description</p>
                        </div>
                        <div class="card-footer bg-white border-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">@((m.NextShowtime.HasValue) ? m.NextShowtime.Value.ToString("dd MMM HH:mm") : "--")</small>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Grid of movies -->
    <div class="row g-3">
        @foreach (var m in Model?.NowShowing ?? Enumerable.Empty<Semester03.Areas.Client.Models.ViewModels.MovieCardVm>())
        {
            <div class="col-6 col-md-4 col-lg-3">
                <div class="card movie-card h-100 position-relative">
                    <a href="@Url.Action("Details", "Cinema", new { area = "Client", id = m.Id })" class="d-block">
                        <img src="@Img(m.PosterUrl)" class="movie-poster card-img-top" alt="@m.Title" />
                    </a>
                    <div class="card-body">
                        <h6 class="card-title mb-1">@m.Title</h6>
                        <small class="text-muted">@((m.DurationMin.HasValue) ? (m.DurationMin.Value + " min") : "--")</small>
                        <p class="small text-truncate mt-2" title="@m.Description">@m.Description</p>
                    </div>
                    <div class="card-footer bg-white border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">@((m.NextShowtime.HasValue) ? m.NextShowtime.Value.ToString("dd MMM HH:mm") : "--")</small>
                            <div>
                                @if (m.NextShowtimeId.HasValue)
                                {
                                    <a class="btn btn-sm btn-primary ms-1" href="@Url.Action("BookTicket", "Booking", new { area = "Client", movieId = m.Id })">Book</a>
                                }
                                else
                                {
                                    <a class="btn btn-sm btn-secondary ms-1 disabled">Book</a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@using Semester03.Areas.Client.Repositories
@using Semester03.Areas.Client.Models.ViewModels
@{
    var _eventRepo = EventRepository.Instance;
    var topEvents = await _eventRepo.GetUpcomingEventsAsync();
    topEvents = topEvents.Take(6).ToList();
}

<h4 class="mb-3">Upcoming Events</h4>
<div class="slider-wrapper mb-3">
    <div id="eventsSliderTrack" class="slider-track">
        @foreach (var e in topEvents)
        {
            <div class="slider-item">
                <div class="card movie-card event-card position-relative h-100">
                    <a href="@Url.Action("Details", "Event", new { area = "Client", id = e.Id })" class="d-block">
                        <img src="@Img(!string.IsNullOrEmpty(e.ImageUrl) ? (e.ImageUrl.StartsWith("/") ? e.ImageUrl.TrimStart('/') : e.ImageUrl) : "/images/event-placeholder.png")"
                             class="movie-poster card-img-top" alt="@e.Title" />
                    </a>
                    <div class="movie-overlay">
                        <div class="w-100 text-center">
                            <div class="movie-title">@e.Title</div>
                            <div class="small">@((e.StartDate.HasValue) ? e.StartDate.Value.ToString("dd MMM HH:mm") : "--")</div>
                            <div class="mt-2">
                                <a class="btn btn-sm btn-light" href="@Url.Action("Details", "Event", new { area = "Client", id = e.Id })">View</a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <div class="fw-semibold">@e.Title</div>
                        <div class="small text-muted">@((e.StartDate.HasValue) ? e.StartDate.Value.ToString("dd MMM HH:mm") : "--")</div>
                        @if (!string.IsNullOrWhiteSpace(e.ShortDescription))
                        {
                            <p class="small text-truncate" title="@e.ShortDescription">@e.ShortDescription</p>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var featured = document.querySelector('#featuredCarousel');
            if (featured) {
                var carousel = new bootstrap.Carousel(featured, { interval: 5000, ride: 'carousel' });
            }

            // Auto slider for horizontal track
            (function () {
                const track = document.getElementById('sliderTrack');
                if (!track) return;
                let pos = 0;
                const gap = 16;
                function computeStep() {
                    const first = track.querySelector('.slider-item');
                    const width = first ? Math.round(first.getBoundingClientRect().width) : 220;
                    return width + gap;
                }

                let autoInterval = setInterval(() => {
                    const step = computeStep();
                    pos += step;
                    const maxScroll = Math.max(0, track.scrollWidth - track.parentElement.clientWidth);
                    if (pos > maxScroll) pos = 0;
                    track.style.transform = `translateX(-${pos}px)`;
                }, 3000);

                track.parentElement.addEventListener('mouseenter', () => clearInterval(autoInterval));
                track.parentElement.addEventListener('mouseleave', () => {
                    autoInterval = setInterval(() => {
                        const step = computeStep();
                        pos += step;
                        const maxScroll = Math.max(0, track.scrollWidth - track.parentElement.clientWidth);
                        if (pos > maxScroll) pos = 0;
                        track.style.transform = `translateX(-${pos}px)`;
                    }, 3000);
                });

                track.style.transform = 'translateX(0)';
            })();
        });


        function filterMovies() {
            const q = document.getElementById('movieSearch').value.toLowerCase();
            document.querySelectorAll('.card.movie-card').forEach(card => {
                const title = (card.querySelector('.card-title')?.innerText || card.querySelector('.movie-title')?.innerText || '').toLowerCase();
                const parent = card.closest('.col-6, .slider-item');
                if (parent) parent.style.display = title.includes(q) ? '' : 'none';
            });
        }
    </script>
}
