@using Semester03.Areas.Client.Models.ViewModels
@inject Semester03.Models.Repositories.EventRepository _eventRepo

@{
    ViewData["Title"] = "Home";
    ViewData["MallName"] = "ABCD Mall";
    Layout = "~/Areas/Client/Views/Shared/_LayoutClient.cshtml";

    // Hàm chuẩn hóa đường dẫn ảnh (hỗ trợ: full URL, /path, đường dẫn trong wwwroot, hoặc Content/Uploads/...)
    Func<string, string> Img = raw =>
    {
        if (string.IsNullOrWhiteSpace(raw))
        {
            return Url.Content("~/images/event-placeholder.png");
        }

        if (raw.StartsWith("http", System.StringComparison.OrdinalIgnoreCase))
        {
            return raw;
        }

        // Loại bỏ "wwwroot/" hoặc "~/" nếu có, và trim ký tự '/'
        var s = raw.Replace("wwwroot/", "").TrimStart('~', '/');
        s = s.Replace(" ", "%20"); // encode space

        // Nếu đường dẫn đã là dạng Content/... hoặc images/...
        if (s.StartsWith("Content", System.StringComparison.OrdinalIgnoreCase)
            || s.StartsWith("images", System.StringComparison.OrdinalIgnoreCase)
            || s.StartsWith("Admin/img", System.StringComparison.OrdinalIgnoreCase))
        {
            return Url.Content("~/" + s);
        }

        // Nếu bắt đầu bằng '/', trả về tương đối từ root
        if (raw.StartsWith("/"))
        {
            return Url.Content("~" + raw);
        }

        // Mặc định: giả định ảnh nằm trong Content/Uploads/Events/
        return Url.Content("~/Content/Uploads/Events/" + s);
    };

    // Lấy 6 sự kiện sắp tới bằng repository được inject (async)
    var topEvents = await _eventRepo.GetUpcomingEventsAsync(6);
    topEvents = topEvents ?? new List<EventCardVm>();
}

<div class="container py-5">
    <h1 class="mb-4 text-center">EVENTS</h1>

    <div class="row g-4">
        @foreach (var e in topEvents)
        {
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden">
                    <a href="@Url.Action("Details", "Event", new { area = "Client", id = e.Id })">
                        <img src="@Img(e.ImageUrl)"
                             class="card-img-top" alt="@e.Title" style="height:200px; object-fit:cover;" />
                    </a>
                    <div class="card-body p-3 text-center">
                        <h6 class="card-title fw-bold">@e.Title</h6>
                        <small class="text-muted d-block mb-1">GIGAMALL</small>
                        @if (!string.IsNullOrWhiteSpace(e.ShortDescription))
                        {
                            <p class="text-secondary small text-truncate" title="@e.ShortDescription">@e.ShortDescription</p>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .card:hover {
        transform: scale(1.02);
        transition: transform 0.3s ease-in-out;
    }

    .card-title {
        font-size: 0.95rem;
    }

    .text-truncate {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
