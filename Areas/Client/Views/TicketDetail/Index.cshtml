@model Semester03.Areas.Client.Models.ViewModels.TicketDetailVm

@using System
@using System.IO
@using Microsoft.AspNetCore.Hosting
@using System.Linq

@{
    Layout = "~/Areas/Client/Views/Shared/_LayoutClient.cshtml";
    ViewData["Title"] = "Movie ticket details";

    var dayOfWeek = Model.Showtime.ToString("dddd", new System.Globalization.CultureInfo("en-US"));

    // ===== IMAGE HELPER FOR MOVIE / POSTER =====
    Func<string, string> ImgMovie = (raw) =>
    {
        var noImageUrl = Url.Content("~/Content/Uploads/noimage.png");

        try
        {
            if (string.IsNullOrWhiteSpace(raw))
                return noImageUrl;

            // if already an absolute URL
            if (raw.StartsWith("http", StringComparison.OrdinalIgnoreCase))
                return raw;

            // normalize
            var file = raw.Replace("\\", "/").Trim();

            // if raw contains "Content/Uploads/Movie" then only keep the last file name
            var keyword = "Content/Uploads/Movie";
            var idxKeyword = file.IndexOf(keyword, StringComparison.OrdinalIgnoreCase);
            if (idxKeyword >= 0)
            {
                var lastSlash = file.LastIndexOf('/');
                if (lastSlash >= 0) file = file.Substring(lastSlash + 1);
            }

            // remove "wwwroot/", "~/" or "/" prefix
            if (file.StartsWith("wwwroot/", StringComparison.OrdinalIgnoreCase))
                file = file.Substring("wwwroot/".Length);
            if (file.StartsWith("~/"))
                file = file.Substring(2);
            if (file.StartsWith("/"))
                file = file.Substring(1);

            if (string.IsNullOrWhiteSpace(file))
                return noImageUrl;

            // get IWebHostEnvironment to check physical file
            var env = Context.RequestServices.GetService(typeof(IWebHostEnvironment)) as IWebHostEnvironment;
            if (env == null)
            {
                // fallback: point to the Movie folder anyway
                return Url.Content("~/Content/Uploads/Movie/" + Uri.EscapeDataString(file));
            }

            var physical = System.IO.Path.Combine(
                env.WebRootPath ?? "wwwroot",
                "Content", "Uploads", "Movie", file
            );

            if (System.IO.File.Exists(physical))
            {
                return Url.Content("~/Content/Uploads/Movie/" + Uri.EscapeDataString(file));
            }
            else
            {
                return noImageUrl;
            }
        }
        catch
        {
            return noImageUrl;
        }
    };
}

<style>
    /* SEAT CANCELLATION CONFIRM OVERLAY */
    .cancel-confirm-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none; /* hidden by default */
        align-items: center;
        justify-content: center;
        z-index: 9998;
    }

    .cancel-confirm-dialog {
        width: 320px;
        max-width: 90%;
        background: #ffffff;
        border-radius: 18px;
        padding: 16px 18px 14px;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.45);
        border: 1px solid rgba(226, 232, 240, 0.9);
        animation: toastIn .2s ease-out;
    }

    .cancel-confirm-title {
        font-weight: 800;
        font-size: 1rem;
        margin-bottom: 4px;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 6px;
    }

        .cancel-confirm-title i {
            color: #ef4444;
        }

    .cancel-confirm-text {
        font-size: .9rem;
        color: #4b5563;
        margin-bottom: 12px;
    }

    .cancel-confirm-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        flex-wrap: wrap;
    }

        .cancel-confirm-actions .btn {
            flex: 1 1 0;
            border-radius: 999px;
            font-weight: 600;
            padding: 8px 12px;
        }

        .cancel-confirm-actions .btn-outline-secondary {
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #4b5563;
        }

            .cancel-confirm-actions .btn-outline-secondary:hover {
                background: #f3f4f6;
            }

    /* ========= CENTER RESULT OVERLAY (SUCCESS / ERROR) ========= */
    .cancel-result-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .cancel-result-box {
        background: #ffffff;
        border-radius: 18px;
        padding: 18px 22px 16px;
        max-width: 360px;
        width: 90%;
        text-align: center;
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.5);
        border: 1px solid rgba(226, 232, 240, 0.95);
        animation: toastIn .2s ease-out;
    }

        .cancel-result-box.success {
            border-top: 4px solid #22c55e;
        }

        .cancel-result-box.error {
            border-top: 4px solid #ef4444;
        }

    .cancel-result-icon {
        width: 52px;
        height: 52px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        font-size: 1.6rem;
    }

    .cancel-result-box.success .cancel-result-icon {
        background: #dcfce7;
        color: #166534;
    }

    .cancel-result-box.error .cancel-result-icon {
        background: #fee2e2;
        color: #b91c1c;
    }

    .cancel-result-title {
        font-weight: 800;
        font-size: 1.1rem;
        margin-bottom: 4px;
        color: #111827;
    }

    .cancel-result-text {
        font-size: .9rem;
        color: #4b5563;
        margin-bottom: 6px;
    }

    .cancel-result-note {
        font-size: .8rem;
        color: #9ca3af;
    }

    /* TOAST MESSAGE FOR CANCELLATION (giữ lại nếu bạn vẫn muốn dùng) */
    .cancel-toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .cancel-toast {
        min-width: 260px;
        max-width: 360px;
        background: #ffffff;
        border-radius: 14px;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35);
        padding: 10px 14px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        border-left: 5px solid #22c55e;
        animation: toastIn 0.2s ease-out;
        font-size: .9rem;
    }

    .cancel-toast-error {
        border-left-color: #ef4444;
    }

    .cancel-toast-icon {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .cancel-toast-success .cancel-toast-icon {
        background: #dcfce7;
        color: #15803d;
    }

    .cancel-toast-error .cancel-toast-icon {
        background: #fee2e2;
        color: #b91c1c;
    }

    .cancel-toast-content-title {
        font-weight: 700;
        margin-bottom: 2px;
        color: #111827;
    }

    .cancel-toast-content-text {
        color: #4b5563;
    }

    .cancel-toast-close {
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 0;
        margin-left: auto;
        font-size: 1rem;
    }

    @@keyframes toastIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* LIGHT BACKGROUND FOR PAGE */
    .ticket-page-bg {
        padding: 20px 0 40px;
        background: radial-gradient(circle at top, #fee2e2 0, #e0f2fe 40%, #f9fafb 100%);
    }

    /* MAIN TICKET WRAPPER */
    .ticket-wrapper {
        max-width: 820px;
        margin: auto;
        background: #ffffff;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.18);
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(226, 232, 240, 0.9);
    }

    .ticket-header {
        padding: 16px 22px;
        background: linear-gradient(90deg, #ffe4ef, #ffe4e6);
        font-weight: 700;
        font-size: 1.1rem;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid rgba(248, 250, 252, 0.9);
    }

        .ticket-header a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: #f97373;
            color: #fff;
            text-decoration: none;
            transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
        }

            .ticket-header a:hover {
                background: #ef4444;
                transform: translateX(-2px);
                box-shadow: 0 8px 18px rgba(239, 68, 68, 0.45);
            }

    /* POSTER – SLIGHTLY HIGHER THAN MyTickets */
    .ticket-media {
        position: relative;
        overflow: hidden;
        background: #020617;
    }

    .ticket-poster {
        width: 100%;
        height: 380px;
        object-fit: cover;
        display: block;
        transform: scale(1.02);
        transition: transform 0.9s ease-out;
    }

    .ticket-media::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(to bottom, rgba(15, 23, 42, 0.4), transparent 25%, transparent 100%);
        pointer-events: none;
    }

    .ticket-wrapper:hover .ticket-poster {
        transform: scale(1.06);
    }

    @@media (max-width: 768px) {
        .ticket-poster {
            height: 260px;
        }
    }

    /* TICKET BODY */
    .ticket-body {
        padding: 22px 22px 24px;
        background: #ffffff;
    }

    .ticket-value-main {
        font-size: 1.3rem;
        font-weight: 800;
        color: #111827;
    }

    .ticket-subinfo {
        font-size: .9rem;
        color: #6b7280;
    }

    .ticket-label {
        font-size: .8rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: #9ca3af;
        font-weight: 600;
    }

    .ticket-value {
        font-size: 1rem;
        font-weight: 700;
        color: #111827;
    }

    .ticket-section {
        margin-top: 16px;
        padding: 14px 16px;
        background: #f9fafb;
        border-radius: 14px;
        border: 1px solid rgba(226, 232, 240, 0.9);
    }

        .ticket-section + .ticket-section {
            margin-top: 12px;
        }

    .ticket-section-strong {
        background: linear-gradient(135deg, #eff6ff, #fdf2ff);
    }

    /* USED STAMP */
    .stamp-used {
        width: 230px;
        opacity: 0.6;
        position: absolute;
        right: 18px;
        top: 270px;
        transform: rotate(-18deg);
        pointer-events: none;
    }

    @@media (max-width: 768px) {
        .stamp-used {
            top: 220px;
            width: 180px;
        }
    }

    /* SEATS */
    .seat-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: #e0f2fe;
        color: #0f172a;
        font-size: 0.8rem;
        margin: 2px 4px 2px 0;
    }

    .seat-badge-cancel {
        background: #fee2e2;
        color: #b91c1c;
    }

    /* BUTTONS – LOCAL STYLE FOR THIS PAGE */
    .ticket-wrapper .btn {
        font-weight: 600;
        border-radius: 999px;
        padding: 9px 18px;
        border: none;
        transition: transform .13s ease, box-shadow .13s ease, background .13s ease, opacity .13s ease;
    }

    .ticket-wrapper .btn-primary {
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45);
    }

        .ticket-wrapper .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 32px rgba(37, 99, 235, 0.6);
            opacity: .96;
        }

    .ticket-wrapper .btn-danger {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
        box-shadow: 0 10px 25px rgba(248, 113, 113, 0.45);
    }

        .ticket-wrapper .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 32px rgba(248, 113, 113, 0.65);
            opacity: .96;
        }

    .ticket-wrapper .btn-outline-light {
        background: #ffffff;
        color: #111827;
        border: 1px solid #e5e7eb;
        box-shadow: 0 6px 15px rgba(15, 23, 42, 0.12);
    }

        .ticket-wrapper .btn-outline-light:hover {
            background: #f9fafb;
            transform: translateY(-1px);
        }

    /* NEW CANCELLATION BOX – NICER */
    #cancelBox {
        margin-top: 14px;
        padding-top: 0;
        border-top: none;
    }

    .cancel-panel {
        background: #ffffff;
        border-radius: 18px;
        border: 1px dashed rgba(148, 163, 184, 0.7);
        padding: 14px 14px 12px;
    }

    .cancel-title {
        font-size: .95rem;
        font-weight: 700;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

        .cancel-title i {
            color: #ef4444;
        }

    .cancel-hint {
        font-size: .85rem;
        color: #6b7280;
        margin-bottom: 10px;
    }

    .seat-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    /* seat pill */
    .seat-pill {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        cursor: pointer;
        font-size: .85rem;
        color: #1e293b;
        box-shadow: 0 6px 14px rgba(148, 163, 184, 0.25);
        transition: background .15s ease, box-shadow .15s ease, transform .12s ease, border-color .15s ease;
    }

        .seat-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(148, 163, 184, 0.4);
        }

        .seat-pill input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .seat-pill.selected {
            background: #fee2e2;
            border-color: #fecaca;
            box-shadow: 0 10px 24px rgba(248, 113, 113, 0.4);
            color: #7f1d1d;
        }

    .seat-pill-code {
        font-weight: 700;
    }

    .seat-pill-price {
        font-size: .78rem;
        color: rgba(30, 64, 175, 0.9);
    }

    .seat-pill.selected .seat-pill-price {
        color: #b91c1c;
    }

    .cancel-summary {
        margin-top: 10px;
        padding: 8px 10px;
        background: #fefce8;
        border-radius: 999px;
        font-size: .85rem;
        color: #854d0e;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 6px;
    }

        .cancel-summary strong {
            font-weight: 800;
        }

    .cancel-selected-box {
        margin-top: 8px;
        padding-top: 6px;
        border-top: 1px dashed rgba(209, 213, 219, 0.9);
    }

    .cancel-selected-title {
        font-size: .85rem;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 4px;
    }

    .cancel-actions {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    @@media (min-width: 576px) {
        .cancel-actions {
            flex-direction: row;
            justify-content: flex-end;
        }

            .cancel-actions .btn {
                min-width: 220px;
            }
    }
</style>

<div class="ticket-page-bg">
    <div class="ticket-wrapper mt-3 mb-3">

        <div class="ticket-header">
            <a href="javascript:history.back()">
                <i class="bi bi-arrow-left"></i>
            </a>
            Movie ticket details
        </div>

        <div class="ticket-media">
            <!-- USE ImgMovie HELPER INSTEAD OF USING Model.MovieImg DIRECTLY -->
            <img src="@ImgMovie(Model.MovieImg)" class="ticket-poster" />
        </div>

        @if (Model.IsUsed)
        {
            <img src="/images/stamp_used.png" class="stamp-used" />
        }

        <div class="ticket-body">
            <div class="ticket-value-main mb-1">@Model.MovieTitle</div>
            <div class="ticket-subinfo mb-3">@Model.Genre - @Model.Duration min</div>

            <div class="ticket-section ticket-section-strong">
                <div class="ticket-label">Booking code</div>
                <div class="ticket-value mb-2">@Model.TicketId</div>

                <div class="ticket-label">Time</div>
                <div class="ticket-value" style="color:#e00063">
                    @Model.Showtime.ToString("HH:mm") - @Model.EndTime.ToString("HH:mm")
                </div>
                <div class="ticket-value">
                    @dayOfWeek, @Model.Showtime.ToString("dd/MM/yyyy")
                </div>
            </div>

            <div class="ticket-section">
                <div class="row text-center">
                    <div class="col-md-5 mb-3 mb-md-0">
                        <div class="ticket-label">Screening room</div>
                        <div class="ticket-value">@Model.Screen</div>
                    </div>
                    <div class="col-md-7">
                        <div class="ticket-label">Booked seats</div>
                        <div class="ticket-value">
                            @if (Model.Seats != null && Model.Seats.Any())
                            {
                                @string.Join(", ", Model.Seats.Select(s => s.SeatLabel))
                            }
                            else
                            {
                                <span>No seats.</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="ticket-section">
                <div class="ticket-label">Cinema</div>
                <div class="ticket-value">@Model.TheaterName</div>
                <div class="ticket-subinfo">@Model.TheaterAddress</div>
            </div>

            <!-- MULTI-SEAT CANCELLATION SECTION – NEW UI -->
            <div class="ticket-section mt-3">
                <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
                    <div>
                        <div class="ticket-label mb-1">Ticket management</div>
                        <div class="ticket-subinfo">
                            You can select individual seats to cancel before the showtime (if the cinema's policy allows).
                        </div>
                    </div>
                    <button class="btn btn-danger" type="button" onclick="toggleCancelBox()">
                        <i class="bi bi-x-circle"></i> Cancel (select seats)
                    </button>
                </div>

                <div id="cancelBox" style="display:none;">
                    <div class="cancel-panel mt-3">
                        <div class="cancel-title">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            Cancel selected seats
                        </div>
                        <div class="cancel-hint">
                            Select the seats you want to cancel. The system will refund the corresponding amount for each seat based on the ticket price.
                        </div>

                        @if (Model.Seats == null || !Model.Seats.Any())
                        {
                            <div class="ticket-label">You no longer have any tickets that can be canceled.</div>
                        }
                        else
                        {
                            <div class="seat-grid">
                                @foreach (var s in Model.Seats)
                                {
                                    <label class="seat-pill">
                                        <input type="checkbox"
                                               class="seat-check"
                                               value="@s.TicketId"
                                               data-seat-label="@s.SeatLabel"
                                               data-seat-price="@s.Price" />
                                        <span class="seat-pill-code">Seat @s.SeatLabel</span>
                                        <span class="seat-pill-price">@s.Price.ToString("N0") đ</span>
                                    </label>
                                }
                            </div>

                            <div class="cancel-summary" id="cancelSummary">
                                <span>Selected <strong>0</strong> seats</span>
                                <span>Estimated refund: <strong>0 đ</strong></span>
                            </div>

                            <div class="cancel-selected-box">
                                <div class="cancel-selected-title">List of seats to be canceled:</div>
                                <div id="selectedSeatsBox">
                                    <span class="ticket-label text-muted">No seats selected.</span>
                                </div>
                            </div>

                            <div class="cancel-actions">
                                <button class="btn btn-outline-light w-100" type="button" onclick="toggleCancelBox()">
                                    Close
                                </button>
                                <button class="btn btn-primary w-100" type="button" onclick="submitCancel()">
                                    Confirm cancellation of selected seats
                                </button>
                            </div>

                            <!-- Cancellation confirmation overlay -->
                            <div id="cancelConfirmOverlay" class="cancel-confirm-overlay">
                                <div class="cancel-confirm-dialog">
                                    <div class="cancel-confirm-title">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        Confirm ticket cancellation
                                    </div>
                                    <div class="cancel-confirm-text" id="cancelConfirmText">
                                        Are you sure you want to cancel 0 seats?
                                    </div>
                                    <div class="cancel-confirm-actions">
                                        <button type="button"
                                                class="btn btn-outline-secondary"
                                                onclick="hideCancelConfirm()">
                                            No, go back
                                        </button>
                                        <button type="button"
                                                class="btn btn-danger"
                                                onclick="doSubmitCancel()">
                                            Confirm cancellation
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- CENTER RESULT OVERLAY -->
        <div id="cancelResultOverlay" class="cancel-result-overlay">
            <div id="cancelResultBox" class="cancel-result-box">
                <div id="cancelResultIcon" class="cancel-result-icon">
                    <i class="bi bi-check2"></i>
                </div>
                <div id="cancelResultTitle" class="cancel-result-title">
                    Cancellation successful
                </div>
                <div id="cancelResultText" class="cancel-result-text">
                    Your request has been processed.
                </div>
                <div class="cancel-result-note">
                    The page will refresh to update your ticket information.
                </div>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        // =======================
        // OPTIONAL: bottom-right toast (giữ lại)
        // =======================
        function showCancelToast(success, message) {
            var container = document.querySelector(".cancel-toast-container");
            if (!container) {
                container = document.createElement("div");
                container.className = "cancel-toast-container";
                document.body.appendChild(container);
            }

            var toast = document.createElement("div");
            toast.className = "cancel-toast " + (success ? "cancel-toast-success" : "cancel-toast-error");

            var icon = document.createElement("div");
            icon.className = "cancel-toast-icon";
            icon.innerHTML = success ? '<i class="bi bi-check2"></i>' : '<i class="bi bi-x-lg"></i>';

            var content = document.createElement("div");
            var title = document.createElement("div");
            title.className = "cancel-toast-content-title";
            title.textContent = success ? "Cancellation successful" : "Cancellation failed";

            var text = document.createElement("div");
            text.className = "cancel-toast-content-text";
            text.textContent = message || (success
                ? "Your cancellation request has been processed."
                : "Unable to cancel the ticket, please try again.");

            content.appendChild(title);
            content.appendChild(text);

            var closeBtn = document.createElement("button");
            closeBtn.className = "cancel-toast-close";
            closeBtn.innerHTML = "&times;";
            closeBtn.onclick = function () {
                if (toast && toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            };

            toast.appendChild(icon);
            toast.appendChild(content);
            toast.appendChild(closeBtn);

            container.appendChild(toast);

            setTimeout(function () {
                if (toast && toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // =======================
        // CENTER RESULT OVERLAY
        // =======================
        function showCenterResult(success, message, autoReload) {
            var overlay = document.getElementById("cancelResultOverlay");
            var box = document.getElementById("cancelResultBox");
            var icon = document.getElementById("cancelResultIcon");
            var title = document.getElementById("cancelResultTitle");
            var text = document.getElementById("cancelResultText");

            if (!overlay || !box) {
                // fallback nếu thiếu DOM
                alert(message || (success ? "Cancellation successful" : "Cancellation failed"));
                if (autoReload) {
                    location.reload();
                }
                return;
            }

            box.classList.remove("success", "error");
            if (success) {
                box.classList.add("success");
                icon.innerHTML = '<i class="bi bi-check2"></i>';
                title.textContent = "Cancellation successful";
            } else {
                box.classList.add("error");
                icon.innerHTML = '<i class="bi bi-x-lg"></i>';
                title.textContent = "Cancellation failed";
            }

            text.textContent = message || (success
                ? "Your cancellation request has been processed."
                : "Unable to cancel the ticket, please try again.");

            overlay.style.display = "flex";

            setTimeout(function () {
                overlay.style.display = "none";
                if (autoReload) {
                    location.reload();
                }
            }, 1600);
        }

        function toggleCancelBox() {
            var box = document.getElementById("cancelBox");
            if (!box) return;

            if (box.style.display === "none" || box.style.display === "") {
                box.style.display = "block";
            } else {
                box.style.display = "none";
            }
        }

        function renderSelectedSeats() {
            var box = document.getElementById("selectedSeatsBox");
            var summary = document.getElementById("cancelSummary");
            if (!box) return;

            box.innerHTML = "";

            var selectedLabels = [];
            var count = 0;
            var totalRefund = 0;

            document.querySelectorAll(".seat-check:checked").forEach(function (chk) {
                var label = chk.getAttribute("data-seat-label") || chk.value;
                var priceStr = chk.getAttribute("data-seat-price") || "0";
                var price = parseFloat(priceStr) || 0;

                selectedLabels.push(label);
                count++;
                totalRefund += price;
            });

            if (selectedLabels.length === 0) {
                box.innerHTML = '<span class="ticket-label text-muted">No seats selected.</span>';
            } else {
                selectedLabels.forEach(function (seat) {
                    var span = document.createElement("span");
                    span.className = "seat-badge seat-badge-cancel";
                    span.textContent = seat;
                    box.appendChild(span);
                });
            }

            if (summary) {
                var formattedRefund = totalRefund.toLocaleString("vi-VN") + " đ";
                summary.innerHTML =
                    '<span>Selected <strong>' + count + '</strong> seats</span>' +
                    '<span>Estimated refund: <strong>' + formattedRefund + '</strong></span>';
            }

            document.querySelectorAll(".seat-pill").forEach(function (pill) {
                var input = pill.querySelector("input.seat-check");
                if (input && input.checked) {
                    pill.classList.add("selected");
                } else {
                    pill.classList.remove("selected");
                }
            });
        }

        // global variable to store seat ids pending cancellation
        var pendingSeatIds = [];

        function submitCancel() {
            pendingSeatIds = [];
            document.querySelectorAll(".seat-check:checked").forEach(function (chk) {
                pendingSeatIds.push(chk.value);
            });

            if (pendingSeatIds.length === 0) {
                showCenterResult(false, "You haven't chosen seats to cancel.", false);
                return;
            }

            var txt = document.getElementById("cancelConfirmText");
            if (txt) {
                txt.textContent = "Are you sure you want to cancel " + pendingSeatIds.length + " seats?";
            }

            var overlay = document.getElementById("cancelConfirmOverlay");
            if (overlay) {
                overlay.style.display = "flex";
            }
        }

        function hideCancelConfirm() {
            var overlay = document.getElementById("cancelConfirmOverlay");
            if (overlay) {
                overlay.style.display = "none";
            }
        }

        function doSubmitCancel() {
            if (!pendingSeatIds || pendingSeatIds.length === 0) {
                hideCancelConfirm();
                showCenterResult(false, "You haven't selected any seat to cancel.", false);
                return;
            }

            hideCancelConfirm();

            var url = "@Url.Action("CancelSelectedSeats", "TicketDetail", new { area = "Client" })";

            var bodyParams = new URLSearchParams();
            pendingSeatIds.forEach(function (id) {
                bodyParams.append("seatIds", id);
            });

            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
                },
                body: bodyParams.toString()
            })
                .then(function (response) { return response.json(); })
                .then(function (res) {
                    var msg = res.message || (res.success ? "Ticket cancellation successful." : "Cannot cancel the ticket.");
                    // dùng center overlay + auto reload
                    showCenterResult(res.success, msg, true);
                })
                .catch(function (err) {
                    console.error(err);
                    showCenterResult(false, "An error occurred while sending the cancellation request.", false);
                });
        }

        // attach events for seat checkboxes after DOM load
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".seat-check").forEach(function (chk) {
                chk.addEventListener("change", renderSelectedSeats);
            });

            // initial render
            renderSelectedSeats();
        });
    </script>
}
