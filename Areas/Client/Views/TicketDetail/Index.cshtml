@model Semester03.Areas.Client.Models.ViewModels.TicketDetailVm

@using System
@using System.IO
@using Microsoft.AspNetCore.Hosting
@using System.Linq

@{
    Layout = "~/Areas/Client/Views/Shared/_LayoutClient.cshtml";
    ViewData["Title"] = "Thông tin vé xem phim";

    var dayOfWeek = Model.Showtime.ToString("dddd", new System.Globalization.CultureInfo("vi-VN"));

    // ===== HÀM ẢNH CHO MOVIE / POSTER =====
    Func<string, string> ImgMovie = (raw) =>
    {
        var noImageUrl = Url.Content("~/Content/Uploads/noimage.png");

        try
        {
            if (string.IsNullOrWhiteSpace(raw))
                return noImageUrl;

            // nếu đã là URL tuyệt đối
            if (raw.StartsWith("http", StringComparison.OrdinalIgnoreCase))
                return raw;

            // chuẩn hóa
            var file = raw.Replace("\\", "/").Trim();

            // nếu raw chứa "Content/Uploads/Movie" thì chỉ lấy file name cuối
            var keyword = "Content/Uploads/Movie";
            var idxKeyword = file.IndexOf(keyword, StringComparison.OrdinalIgnoreCase);
            if (idxKeyword >= 0)
            {
                var lastSlash = file.LastIndexOf('/');
                if (lastSlash >= 0) file = file.Substring(lastSlash + 1);
            }

            // bỏ prefix "wwwroot/", "~/" hoặc "/"
            if (file.StartsWith("wwwroot/", StringComparison.OrdinalIgnoreCase))
                file = file.Substring("wwwroot/".Length);
            if (file.StartsWith("~/"))
                file = file.Substring(2);
            if (file.StartsWith("/"))
                file = file.Substring(1);

            if (string.IsNullOrWhiteSpace(file))
                return noImageUrl;

            // lấy IWebHostEnvironment để check file thật
            var env = Context.RequestServices.GetService(typeof(IWebHostEnvironment)) as IWebHostEnvironment;
            if (env == null)
            {
                // fallback: cứ trỏ vào thư mục Movie
                return Url.Content("~/Content/Uploads/Movie/" + Uri.EscapeDataString(file));
            }

            var physical = System.IO.Path.Combine(
                env.WebRootPath ?? "wwwroot",
                "Content", "Uploads", "Movie", file
                );


            if (System.IO.File.Exists(physical))
            {
                return Url.Content("~/Content/Uploads/Movie/" + Uri.EscapeDataString(file));
            }
            else
            {
                return noImageUrl;
            }
        }
        catch
        {
            return noImageUrl;
        }
    };
}

<style>
    .ticket-wrapper {
        max-width: 700px;
        margin: auto;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        overflow: hidden;
    }

    .ticket-header {
        padding: 20px;
        background: #ffe0e9;
        font-weight: 700;
        font-size: 1.3rem;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .ticket-header i {
            cursor: pointer;
        }

    .ticket-poster {
        width: 100%;
        height: 300px;
        object-fit: cover;
    }

    .ticket-body {
        padding: 20px;
        background: #fff;
    }

    .ticket-label {
        font-size: .9rem;
        color: #666;
    }

    .ticket-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: #000;
    }

    .stamp-used {
        width: 240px;
        opacity: 0.7;
        position: absolute;
        right: 20px;
        top: 350px;
        transform: rotate(-20deg);
    }

    .ticket-section {
        margin-top: 15px;
        padding: 15px;
        background: #fafafa;
        border-radius: 12px;
        border: 1px solid #eee;
    }

    .seat-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: #e0f2fe;
        color: #0f172a;
        font-size: 0.8rem;
        margin: 2px 4px 2px 0;
    }

    .seat-badge-cancel {
        background: #fee2e2;
        color: #b91c1c;
    }
</style>

<div class="ticket-wrapper mt-4 mb-4 position-relative">

    <div class="ticket-header">
        <a href="javascript:history.back()">
            <i class="bi bi-arrow-left"></i>
        </a>
        Thông tin vé xem phim
    </div>

    <!-- DÙNG HÀM ImgMovie THAY VÌ DÙNG TRỰC TIẾP Model.MovieImg -->
    <img src="@ImgMovie(Model.MovieImg)" class="ticket-poster" />

    @if (Model.IsUsed)
    {
        <img src="/images/stamp_used.png" class="stamp-used" />
    }

    <div class="ticket-body">

        <div class="ticket-value mb-1">@Model.MovieTitle</div>
        <div class="ticket-label mb-3">@Model.Genre - @Model.Duration phút</div>

        <div class="ticket-section">
            <div class="ticket-label">Mã đặt vé:</div>
            <div class="ticket-value">@Model.TicketId</div>

            <div class="ticket-label mt-3">Thời gian:</div>
            <div class="ticket-value" style="color:#e00063">
                @Model.Showtime.ToString("HH:mm") - @Model.EndTime.ToString("HH:mm")
            </div>
            <div class="ticket-value">
                @dayOfWeek, @Model.Showtime.ToString("dd/MM/yyyy")
            </div>
        </div>

        <div class="ticket-section">
            <div class="row text-center">
                <div class="col">
                    <div class="ticket-label">Phòng chiếu</div>
                    <div class="ticket-value">@Model.Screen</div>
                </div>
                <div class="col">
                    <div class="ticket-label">Các ghế đã đặt</div>
                    <div class="ticket-value">
                        @if (Model.Seats != null && Model.Seats.Any())
                        {
                            @string.Join(", ", Model.Seats.Select(s => s.SeatLabel))
                        }
                        else
                        {
                            <span>Không có ghế nào.</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="ticket-section">
            <div class="ticket-label">Rạp chiếu</div>
            <div class="ticket-value">@Model.TheaterName</div>
            <div>@Model.TheaterAddress</div>
        </div>

        <!-- KHỐI HỦY VÉ NHIỀU GHẾ GIỮ NGUYÊN -->
        <div class="ticket-section mt-3">
            <button class="btn btn-danger w-100" type="button" onclick="toggleCancelBox()">
                Hủy vé (chọn ghế)
            </button>

            <div id="cancelBox" class="mt-3" style="display:none;">
                <h5>Chọn ghế cần hủy</h5>

                @if (Model.Seats == null || !Model.Seats.Any())
                {
                    <div class="ticket-label">Bạn không còn ghế nào có thể hủy.</div>
                }
                else
                {
                    @foreach (var s in Model.Seats)
                    {
                        <div class="form-check">
                            <input class="form-check-input seat-check"
                                   type="checkbox"
                                   value="@s.TicketId"
                                   id="seat_@s.TicketId"
                                   data-seat-label="@s.SeatLabel" />
                            <label class="form-check-label" for="seat_@s.TicketId">
                                Ghế @s.SeatLabel (@s.Price.ToString("N0") đ)
                            </label>
                        </div>
                    }

                    <button class="btn btn-primary w-100 mt-3" type="button" onclick="submitCancel()">
                        Xác nhận hủy những ghế đã chọn
                    </button>
                }

                <hr />

                <h6>Ghế muốn hủy:</h6>
                <div id="selectedSeatsBox">
                    <span class="ticket-label text-muted">Chưa chọn ghế nào.</span>
                </div>
            </div>
        </div>

    </div>

</div>

@section Scripts {
    <script>
        function toggleCancelBox() {
            var box = document.getElementById("cancelBox");
            if (!box) return;

            if (box.style.display === "none" || box.style.display === "") {
                box.style.display = "block";
            } else {
                box.style.display = "none";
            }
        }

        function renderSelectedSeats() {
            var box = document.getElementById("selectedSeatsBox");
            if (!box) return;

            box.innerHTML = "";

            var selected = [];
            document.querySelectorAll(".seat-check:checked").forEach(function (chk) {
                var label = chk.getAttribute("data-seat-label") || chk.value;
                selected.push(label);
            });

            if (selected.length === 0) {
                box.innerHTML = '<span class="ticket-label text-muted">Chưa chọn ghế nào.</span>';
                return;
            }

            selected.forEach(function (seat) {
                var span = document.createElement("span");
                span.className = "seat-badge seat-badge-cancel";
                span.textContent = seat;
                box.appendChild(span);
            });
        }

        function submitCancel() {
            var selected = [];
            document.querySelectorAll(".seat-check:checked").forEach(function (chk) {
                selected.push(chk.value);
            });

            if (selected.length === 0) {
                alert("Bạn chưa chọn ghế để hủy.");
                return;
            }

            if (!confirm("Bạn có chắc muốn hủy " + selected.length + " ghế?")) {
                return;
            }

            var url = "@Url.Action("CancelSelectedSeats", "TicketDetail", new { area = "Client" })";

            var bodyParams = new URLSearchParams();
            selected.forEach(function (id) {
                bodyParams.append("seatIds", id);
            });

            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
                },
                body: bodyParams.toString()
            })
                .then(function (response) { return response.json(); })
                .then(function (res) {
                    alert(res.message || "Đã xử lý xong.");
                    if (res.success) {
                        location.reload();
                    }
                })
                .catch(function (err) {
                    console.error(err);
                    alert("Có lỗi xảy ra khi gửi yêu cầu hủy vé.");
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".seat-check").forEach(function (chk) {
                chk.addEventListener("change", renderSelectedSeats);
            });
            renderSelectedSeats();
        });
    </script>
}
